
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>VBMS - Virtual Business Management System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --accent:#f0b90b;
      --light:#fff;
      --bg:#121212;
      --glass:rgba(20,20,20,.85);
      --border:rgba(240,185,11,.22);
      --rail:#222;
      --thumb:#555;
      --sidebar-bg: #111;
      --sidebar-heading: #888;
      --sidebar-link: #ccc;
      --sidebar-link-active: #000;
      --card-bg: #202020;
      --card-shadow: 0 0 8px rgba(240,185,11,.22);
      --card-title: #f0b90b;
      --input-bg: #222;
      --input-border: var(--accent);
      --badge-due: #f0a500;
      --badge-new: #21a1ff;
      --task-done: #28c028;
      --card-shadow-heavy: 0 0 22px 2px rgba(240,185,11,.20);
    }

    html {
      position: relative;
      background: var(--bg);
      height: 100%;
      transition: background 0.3s ease;
    }

    body {
      font-family: 'Inter',Arial,sans-serif;
      color: var(--light);
      background: transparent;
      overflow-x: hidden;
      margin: 0;
      height: 100%;
      transition: background 0.3s ease, color 0.3s ease;
    }

    /* Sidebar Styles */
    nav.sidebar {
      position: fixed;
      top: 0; left: 0;
      width: 280px;
      height: 100vh;
      background: var(--sidebar-bg) !important;
      border-right: 1px solid var(--border);
      padding: 2rem 1rem;
      display: flex; flex-direction: column;
      overflow-y: auto;
      transition: .3s;
      scrollbar-width: thin;
      scrollbar-color: transparent transparent;
      z-index: 1000;
    }

    .logo {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 2rem;
      margin-top: 1.5rem;
    }

    .logo img {
      max-width: 180px;
      transition: .3s;
    }

    .logo-eye-anim {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
      overflow: visible;
    }

    .sidebar-heading {
      font-size: .72rem;
      color: var(--sidebar-heading);
      margin: .8rem 0 .4rem .4rem;
      text-transform: uppercase;
      font-weight: 600;
    }

    .sidebar-link {
      display: flex;
      align-items: center;
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 6px;
      color: var(--sidebar-link);
      text-decoration: none;
      cursor: pointer;
      transition: .2s;
      font-weight: 500;
    }

    .sidebar-link i {
      margin-right: 10px;
      font-size: 1.15rem;
      width: 20px;
      text-align: center;
    }

    .sidebar-link:hover, .sidebar-link.active {
      background: var(--accent);
      color: var(--sidebar-link-active) !important;
      font-weight: 700;
    }

    .btn-logout {
      margin-top: auto;
      width: 100%;
      background: #FFD600;
      border: none;
      color: #000;
      font-weight: 700;
      border-radius: 6px;
      padding: 0.75rem;
    }

    /* Main Content Area */
    .main {
      margin-left: 280px;
      padding: 1.2rem;
      transition: .3s;
      min-height: 100vh;
    }

    /* Loading indicator */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
      font-size: 1.2rem;
      color: var(--accent);
    }

    @media(max-width:768px) {
      nav.sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }
      nav.sidebar.open {
        transform: translateX(0);
      }
      .main {
        margin-left: 0 !important;
        padding: 0.8rem !important;
      }
    }
  </style>
</head>
<body>
  <!-- STATIC SIDEBAR - LOADS ONCE -->
  <nav class="sidebar" id="sidebar">
    <div class="logo">
      <img src="https://iili.io/F7bM6Jt.md.png" alt="VBMS">
      <span class="logo-eye-anim">
        <svg width="49" height="49" style="display:block; overflow:visible;">
          <circle cx="24.5" cy="23" r="13" stroke="#FFD600" stroke-width="2.2" fill="none" opacity="0.17">
            <animate attributeName="r" values="13;18;13" dur="1.3s" repeatCount="indefinite"/>
            <animate attributeName="opacity" values="0.17;0.33;0.17" dur="1.3s" repeatCount="indefinite"/>
          </circle>
          <circle cx="24.5" cy="23" r="6.3" fill="#FFD600" opacity="0.77">
            <animate attributeName="opacity" values="0.77;0.21;0.77" dur="1.12s" repeatCount="indefinite"/>
          </circle>
          <path d="M24.5,8 A15,15 0 0 1 39,23" stroke="#FFD600" stroke-width="2.7" stroke-linecap="round" fill="none" opacity="0.7">
            <animateTransform
              attributeName="transform"
              type="rotate"
              from="0 24.5 23"
              to="360 24.5 23"
              dur="1.24s"
              repeatCount="indefinite"/>
          </path>
          <rect x="-20" y="19" width="15" height="5" fill="#fff" opacity="0.15"
                transform="rotate(45 10 24.5)">
            <animate attributeName="x" values="-20;60" dur="3s" repeatCount="indefinite"/>
            <animate attributeName="opacity" values="0;0.2;0" dur="3s" repeatCount="indefinite"/>
          </rect>
        </svg>
      </span>
    </div>
    
    <p class="sidebar-heading">CORE</p>
    <a class="sidebar-link active" href="#" data-page="dashboard"><i class="bi bi-speedometer2"></i><span>Dashboard</span></a>
    <a class="sidebar-link" href="#" data-page="reports"><i class="bi bi-bar-chart-line"></i><span>Reports</span></a>
    
    <p class="sidebar-heading">OPERATIONS</p>
    <a class="sidebar-link" href="#" data-page="orders"><i class="bi bi-box"></i><span>Orders</span></a>
    <a class="sidebar-link" href="#" data-page="monitoring"><i class="bi bi-camera-video"></i><span>Monitoring</span></a>
    <a class="sidebar-link" href="#" data-page="inventory"><i class="bi bi-stack"></i><span>Inventory</span></a>
    <a class="sidebar-link" href="#" data-page="calendar"><i class="bi bi-calendar-event"></i><span>Calendar</span></a>
    
    <p class="sidebar-heading">PEOPLE & CLIENTS</p>
    <a class="sidebar-link" href="#" data-page="team"><i class="bi bi-people"></i><span>Team</span></a>
    <a class="sidebar-link" href="#" data-page="clients"><i class="bi bi-person-badge"></i><span>Clients</span></a>
    <a class="sidebar-link" href="#" data-page="leads"><i class="bi bi-person-lines-fill"></i><span>Leads</span></a>
    
    <p class="sidebar-heading">TASKS & COMMUNICATION</p>
    <a class="sidebar-link" href="#" data-page="task-board"><i class="bi bi-kanban"></i><span>Task Manager</span></a>
    <a class="sidebar-link" href="#" data-page="messaging"><i class="bi bi-chat-dots"></i><span>Messaging</span></a>
    
    <p class="sidebar-heading">AI TOOLS</p>
    <a class="sidebar-link" href="#" data-page="Aiphone"><i class="bi bi-telephone"></i><span>AI Phone</span></a>
    <a class="sidebar-link" href="#" data-page="Aiassistant"><i class="bi bi-robot"></i><span>AI Assistant</span></a>
    
    <p class="sidebar-heading">BUSINESS TOOLS</p>
    <a class="sidebar-link" href="#" data-page="billing"><i class="bi bi-credit-card-2-front"></i><span>Billing</span></a>
    <a class="sidebar-link" href="#" data-page="settings"><i class="bi bi-gear"></i><span>Settings</span></a>
    <a class="sidebar-link" href="#" data-page="training"><i class="bi bi-mortarboard"></i><span>Training</span></a>
    
    <p class="sidebar-heading">DEV/UTILITY</p>
    <a class="sidebar-link" href="#" data-page="wizard"><i class="bi bi-tools"></i><span>Wizard (Dev)</span></a>
    <a class="sidebar-link" href="#" data-page="wizard-step2"><i class="bi bi-tools"></i><span>Wizard Step 2</span></a>
    <a class="sidebar-link" href="#" data-page="wizard-step3"><i class="bi bi-tools"></i><span>Wizard Step 3</span></a>
    
    <button class="btn btn-warning btn-logout" onclick="logout()"><i class="bi bi-box-arrow-left"></i> Logout</button>
  </nav>

  <!-- DYNAMIC CONTENT AREA - ONLY THIS CHANGES -->
  <main class="main" id="main-content">
    <div class="loading">
      <i class="bi bi-arrow-clockwise" style="animation: spin 1s linear infinite; margin-right: 10px;"></i>
      Loading Dashboard...
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="auth.js"></script>
  <script>
    // SPA Navigation System
    class VBMSApp {
      constructor() {
        this.currentPage = 'dashboard';
        this.contentArea = document.getElementById('main-content');
        this.sidebarLinks = document.querySelectorAll('.sidebar-link[data-page]');
        this.init();
      }

      init() {
        // Bind navigation events
        this.sidebarLinks.forEach(link => {
          link.addEventListener('click', (e) => {
            e.preventDefault();
            const page = link.dataset.page;
            this.navigateTo(page);
          });
        });

        // Load initial page
        this.loadPage('dashboard');
      }

      async navigateTo(page) {
        if (page === this.currentPage) return;
        
        // Update active sidebar link
        this.updateActiveLink(page);
        
        // Load new content
        await this.loadPage(page);
        
        this.currentPage = page;
      }

      updateActiveLink(page) {
        // Remove active from all links
        this.sidebarLinks.forEach(link => link.classList.remove('active'));
        
        // Add active to current link
        const activeLink = document.querySelector(`[data-page="${page}"]`);
        if (activeLink) {
          activeLink.classList.add('active');
        }
      }

      async loadPage(page) {
        try {
          this.contentArea.innerHTML = `
            <div class="loading">
              <i class="bi bi-arrow-clockwise" style="animation: spin 1s linear infinite; margin-right: 10px;"></i>
              Loading ${page}...
            </div>
          `;

          const response = await fetch(`${page}.html`);
          if (!response.ok) throw new Error('Page not found');
          
          const html = await response.text();
          
          // Extract only the main content (everything inside <main> tag)
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          let mainContent = doc.querySelector('main');
          
          if (mainContent) {
            this.contentArea.innerHTML = mainContent.innerHTML;
          } else {
            // Fallback: extract body content and remove sidebar, nav, and scripts
            const bodyContent = doc.querySelector('body');
            if (bodyContent) {
              // Clone the body content
              const tempDiv = document.createElement('div');
              tempDiv.innerHTML = bodyContent.innerHTML;
              
              // Remove sidebar, nav, and script elements
              const elementsToRemove = tempDiv.querySelectorAll('nav, aside, .sidebar, script');
              elementsToRemove.forEach(el => el.remove());
              
              // Look for main content container or use the remaining content
              const mainContainer = tempDiv.querySelector('.main, .content, .container') || tempDiv;
              this.contentArea.innerHTML = mainContainer.innerHTML || tempDiv.innerHTML;
            } else {
              throw new Error('No content found');
            }
          }

          // Re-run any page-specific scripts
          this.executePageScripts();
          
        } catch (error) {
          console.error('Error loading page:', error);
          this.contentArea.innerHTML = `
            <div class="alert alert-danger">
              <h4>Page Not Found</h4>
              <p>Sorry, the page "${page}" could not be loaded.</p>
              <p>Error: ${error.message}</p>
            </div>
          `;
        }
      }

      executePageScripts() {
        // Execute inline scripts in the loaded content
        const scripts = this.contentArea.querySelectorAll('script');
        scripts.forEach(script => {
          const newScript = document.createElement('script');
          newScript.textContent = script.textContent;
          script.parentNode.replaceChild(newScript, script);
        });
      }
    }

    // Auth check - redirect based on role
    if (!vbmsAuth.isAuthenticated()) {
      window.location.href = 'login.html';
      return;
    }

    // Enhanced role-based redirect with race condition protection
    const userRole = vbmsAuth.getCurrentRole();
    console.log('Initial role check in app.html:', userRole);
    
    if (userRole === 'admin') {
      // Admin stays on app.html (SPA)
      console.log('Admin user confirmed, staying on app.html');
    } else if (userRole === 'staff' || userRole === 'editor') {
      console.log('Staff/editor user, redirecting to staff dashboard');
      window.location.href = 'staffdashboard.html';
      return;
    } else if (userRole === 'customer' || userRole === 'client') {
      // Double-check with delay to prevent race conditions
      setTimeout(() => {
        const verifiedRole = vbmsAuth.getCurrentRole();
        console.log('Role verification after delay:', verifiedRole);
        
        if ((verifiedRole === 'customer' || verifiedRole === 'client') && 
            verifiedRole === userRole) {
          console.log('Verified customer/client, redirecting to customer dashboard');
          window.location.href = 'customer-dashboard.html';
        } else {
          console.log('Role changed or uncertain, redirecting to login');
          window.location.href = 'login.html';
        }
      }, 150);
      return;
    } else {
      console.log('Unknown or empty role, redirecting to login');
      window.location.href = 'login.html';
      return;
    }

    // Initialize the app
    const app = new VBMSApp();

    // Logout function
    function logout() {
      vbmsAuth.logout();
    }

    // Add spinning animation
    const style = document.createElement('style');
    style.textContent = `
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>
