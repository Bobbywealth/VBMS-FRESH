<!-- VAPI Customer Widget - AI Phone support and call history -->
<div class="customer-vapi-widget">
    <div class="vapi-header">
        <h5><i class="bi bi-headset"></i> AI Phone Support</h5>
        <div class="vapi-status">
            <div class="status-indicator connected"></div>
            <span>Available 24/7</span>
        </div>
    </div>

    <!-- Quick Call Actions -->
    <div class="quick-actions">
        <button class="action-btn primary" onclick="requestCallback()">
            <i class="bi bi-telephone-inbound"></i>
            <span>Request Callback</span>
        </button>
        <button class="action-btn secondary" onclick="startLiveChat()">
            <i class="bi bi-chat-dots"></i>
            <span>Live Chat</span>
        </button>
    </div>

    <!-- Call History Summary -->
    <div class="call-summary">
        <div class="summary-item">
            <div class="summary-icon">
                <i class="bi bi-telephone text-primary"></i>
            </div>
            <div class="summary-content">
                <div class="summary-number" id="total-calls">0</div>
                <div class="summary-label">Total Calls</div>
            </div>
        </div>
        <div class="summary-item">
            <div class="summary-icon">
                <i class="bi bi-clock text-success"></i>
            </div>
            <div class="summary-content">
                <div class="summary-number" id="avg-resolution">0m</div>
                <div class="summary-label">Avg Resolution</div>
            </div>
        </div>
        <div class="summary-item">
            <div class="summary-icon">
                <i class="bi bi-emoji-smile text-warning"></i>
            </div>
            <div class="summary-content">
                <div class="summary-number" id="satisfaction">0</div>
                <div class="summary-label">Satisfaction</div>
            </div>
        </div>
    </div>

    <!-- Recent Support Calls -->
    <div class="recent-calls">
        <div class="section-header">
            <h6>Recent Support Calls</h6>
            <a href="#" onclick="viewAllCalls()" class="text-primary">View All</a>
        </div>
        <div class="calls-list" id="customer-calls-list">
            <!-- Calls will be loaded here -->
        </div>
    </div>

    <!-- AI Assistant Preview -->
    <div class="ai-preview">
        <div class="ai-avatar">
            <i class="bi bi-robot"></i>
        </div>
        <div class="ai-message">
            <p>"Hi! I'm your AI assistant. I can help with account questions, technical support, and more. Call anytime!"</p>
            <div class="ai-capabilities">
                <span class="capability">Account Help</span>
                <span class="capability">Tech Support</span>
                <span class="capability">Billing</span>
            </div>
        </div>
    </div>
</div>

<!-- Callback Request Modal -->
<div class="modal fade" id="callbackModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Request AI Callback</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="callbackForm">
                    <div class="mb-3">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" id="callback-phone" required>
                        <div class="form-text">We'll call you within 2 minutes</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">What do you need help with?</label>
                        <select class="form-select" id="callback-topic">
                            <option value="general">General Support</option>
                            <option value="technical">Technical Issue</option>
                            <option value="billing">Billing Question</option>
                            <option value="account">Account Settings</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Brief Description (Optional)</label>
                        <textarea class="form-control" id="callback-description" rows="2" placeholder="Describe your issue briefly..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitCallback()">Request Callback</button>
            </div>
        </div>
    </div>
</div>

<style>
.customer-vapi-widget {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    position: relative;
    overflow: hidden;
}

.customer-vapi-widget::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    z-index: 0;
}

.customer-vapi-widget > * {
    position: relative;
    z-index: 1;
}

.vapi-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.vapi-header h5 {
    margin: 0;
    font-weight: 600;
}

.vapi-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    opacity: 0.9;
}

.status-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #28a745;
    animation: pulse 2s infinite;
}

.quick-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.action-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem;
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    text-decoration: none;
    transition: all 0.3s ease;
    cursor: pointer;
}

.action-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.4);
    transform: translateY(-2px);
    color: white;
}

.action-btn i {
    font-size: 1.5rem;
}

.action-btn span {
    font-size: 0.875rem;
    font-weight: 600;
}

.call-summary {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.summary-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
}

.summary-icon {
    font-size: 1.25rem;
}

.summary-number {
    font-size: 1.125rem;
    font-weight: 700;
}

.summary-label {
    font-size: 0.75rem;
    opacity: 0.8;
}

.recent-calls {
    margin-bottom: 1.5rem;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.section-header h6 {
    margin: 0;
    font-weight: 600;
}

.section-header a {
    color: rgba(255, 255, 255, 0.8);
    text-decoration: none;
    font-size: 0.875rem;
}

.section-header a:hover {
    color: white;
}

.calls-list {
    max-height: 150px;
    overflow-y: auto;
}

.call-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    margin-bottom: 0.5rem;
}

.call-info {
    flex: 1;
}

.call-topic {
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.call-details {
    font-size: 0.75rem;
    opacity: 0.8;
}

.call-status {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.2);
}

.ai-preview {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 12px;
}

.ai-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    flex-shrink: 0;
}

.ai-message p {
    margin: 0 0 0.75rem 0;
    font-size: 0.875rem;
    line-height: 1.4;
}

.ai-capabilities {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.capability {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 12px;
}

.no-calls-message {
    text-align: center;
    padding: 1rem;
    opacity: 0.7;
    font-style: italic;
}

@media (max-width: 768px) {
    .quick-actions {
        grid-template-columns: 1fr;
    }
    
    .call-summary {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
class CustomerVAPIWidget {
    constructor() {
        this.API_BASE = window.location.hostname === 'localhost' 
            ? 'http://localhost:5050' 
            : 'https://vbms-fresh-production.up.railway.app';
        this.init();
    }

    async init() {
        console.log('📞 Initializing Customer VAPI Widget...');
        await this.loadCustomerCallData();
    }

    async loadCustomerCallData() {
        try {
            const token = localStorage.getItem('vbmsToken');
            if (!token) return;

            // Load customer's call history and stats
            const response = await fetch(`${this.API_BASE}/api/vapi/calls/customer`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                const data = await response.json();
                this.updateCallSummary(data.stats);
                this.updateRecentCalls(data.calls);
            }
        } catch (error) {
            console.error('❌ Customer VAPI Error:', error);
        }
    }

    updateCallSummary(stats) {
        const elements = {
            'total-calls': stats.totalCalls || 0,
            'avg-resolution': this.formatDuration(stats.avgResolution || 0),
            'satisfaction': stats.avgSatisfaction ? `${stats.avgSatisfaction}/5` : 'N/A'
        };

        Object.entries(elements).forEach(([id, value]) => {
            const el = document.getElementById(id);
            if (el) el.textContent = value;
        });
    }

    updateRecentCalls(calls) {
        const container = document.getElementById('customer-calls-list');
        if (!container) return;

        if (!calls || calls.length === 0) {
            container.innerHTML = '<div class="no-calls-message">No recent calls</div>';
            return;
        }

        container.innerHTML = calls.slice(0, 3).map(call => `
            <div class="call-item">
                <div class="call-info">
                    <div class="call-topic">${call.topic || 'Support Call'}</div>
                    <div class="call-details">${this.formatTime(call.createdAt)} • ${this.formatDuration(call.duration)}</div>
                </div>
                <div class="call-status">${call.status}</div>
            </div>
        `).join('');
    }

    formatDuration(seconds) {
        if (!seconds) return '0m';
        const mins = Math.floor(seconds / 60);
        return mins > 0 ? `${mins}m` : '<1m';
    }

    formatTime(timestamp) {
        if (!timestamp) return '';
        const date = new Date(timestamp);
        const now = new Date();
        const diff = now - date;
        const days = Math.floor(diff / (24 * 60 * 60 * 1000));
        
        if (days === 0) return 'Today';
        if (days === 1) return 'Yesterday';
        if (days < 7) return `${days} days ago`;
        return date.toLocaleDateString();
    }
}

// Global functions
function requestCallback() {
    const modal = new bootstrap.Modal(document.getElementById('callbackModal'));
    modal.show();
    
    // Pre-fill phone number if available
    const user = JSON.parse(localStorage.getItem('vbmsUser') || '{}');
    const phoneInput = document.getElementById('callback-phone');
    if (phoneInput && user.phone) {
        phoneInput.value = user.phone;
    }
}

function startLiveChat() {
    // Redirect to customer support chat or open chat widget
    console.log('Starting live chat...');
    window.location.href = 'customer-ai.html';
}

function viewAllCalls() {
    // Navigate to full call history page
    console.log('Viewing all calls...');
    // Could open a modal or navigate to a dedicated page
    alert('Call history feature coming soon!');
}

async function submitCallback() {
    try {
        const phone = document.getElementById('callback-phone').value;
        const topic = document.getElementById('callback-topic').value;
        const description = document.getElementById('callback-description').value;

        if (!phone) {
            alert('Please enter your phone number');
            return;
        }

        const token = localStorage.getItem('vbmsToken');
        const API_BASE = window.location.hostname === 'localhost' 
            ? 'http://localhost:5050' 
            : 'https://vbms-fresh-production.up.railway.app';

        const response = await fetch(`${API_BASE}/api/vapi/callback`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                phoneNumber: phone,
                topic: topic,
                description: description
            })
        });

        if (response.ok) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('callbackModal'));
            modal.hide();
            
            // Show success message
            alert('✅ Callback requested! Our AI assistant will call you within 2 minutes.');
            
            // Reset form
            document.getElementById('callbackForm').reset();
            
            // Reload call data
            if (window.customerVAPIWidget) {
                window.customerVAPIWidget.loadCustomerCallData();
            }
        } else {
            const error = await response.json();
            alert(`Error: ${error.message || 'Failed to request callback'}`);
        }
    } catch (error) {
        console.error('Callback request error:', error);
        alert('Error requesting callback. Please try again.');
    }
}

// Initialize widget
document.addEventListener('DOMContentLoaded', function() {
    window.customerVAPIWidget = new CustomerVAPIWidget();
});
</script>
