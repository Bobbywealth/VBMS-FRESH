<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Register – VBMS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    :root {
      --accent: #f0b90b;
      --bg: #121212;
      --glass: rgba(20,20,20,.87);
      --border: rgba(240,185,11,.15);
      --input-bg: #191919;
      --input-border: #f0b90b;
      --error: #ff4c4c;
      --success: #1ee16d;
    }
    body {
      min-height: 100vh;
      background: var(--bg);
      font-family: 'Inter', Arial, sans-serif;
      color: #fff;
      margin: 0;
    }
    .vbms-logo {
      max-width: 180px;
      margin: 2.5rem auto 1.5rem auto;
      display: block;
    }
    .glass-card {
      background: var(--glass);
      border-radius: 17px;
      box-shadow: 0 0 24px 2px rgba(240,185,11,.09);
      border: 1.5px solid var(--border);
      padding: 2.2rem 2.6rem 2.1rem 2.6rem;
      max-width: 420px;
      margin: 2.2rem auto;
    }
    .form-title {
      font-size: 2rem;
      font-weight: 800;
      color: var(--accent);
      margin-bottom: 0.7rem;
      text-align: center;
      letter-spacing: 0.01em;
    }
    .form-desc {
      color: #ffd659;
      text-align: center;
      margin-bottom: 1.4rem;
      font-size: 1.04rem;
    }
    .form-floating > .form-control, .form-floating > .form-select {
      background: var(--input-bg);
      color: #fff;
      border: 1.5px solid var(--input-border);
      border-radius: 7px;
    }
    .form-floating > label {
      color: #888;
    }
    .input-icon {
      position: absolute;
      left: 13px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--accent);
      font-size: 1.15rem;
    }
    .form-floating input, .form-floating select {
      padding-left: 2.2rem !important;
    }
    .show-pass-btn {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: #ffe066;
      font-size: 1.2rem;
      cursor: pointer;
    }
    .form-check-label {
      color: #ffe066;
    }
    .error-message, .success-message {
      text-align: center;
      margin-bottom: 1rem;
      font-size: 1.03rem;
      font-weight: 600;
    }
    .error-message { color: var(--error); }
    .success-message { color: var(--success); }
    .btn-gold {
      background: var(--accent);
      color: #191919;
      font-weight: 700;
      border: none;
      border-radius: 8px;
      padding: .8em 0;
      font-size: 1.15rem;
      box-shadow: 0 2px 10px #f0b90b34;
      width: 100%;
      margin-top: .2rem;
      transition: background .13s;
    }
    .btn-gold:hover { background: #ffe066; }
    .login-link {
      color: #ffd659;
      text-align: center;
      display: block;
      margin-top: 1.15rem;
      text-decoration: underline;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @media (max-width:600px){
      .glass-card { padding: 1.2rem 0.5rem; }
      .vbms-logo { max-width: 130px; }
    }
  </style>
</head>
<body>
  <img src="https://iili.io/F7bM6Jt.md.png" class="vbms-logo" alt="VBMS Logo"/>
  <div class="glass-card">
    <div class="form-title">Create Your Account</div>
    <div class="form-desc">Join VBMS – it's free to get started!</div>
    <form id="registerForm" autocomplete="off">
      <input type="hidden" name="role" value="client">
      <div class="mb-3 position-relative">
        <span class="input-icon"><i class="bi bi-person"></i></span>
        <div class="form-floating">
          <input type="text" class="form-control" id="name" placeholder="Full Name" required>
          <label for="name">Full Name</label>
        </div>
      </div>
      <div class="mb-3 position-relative">
        <span class="input-icon"><i class="bi bi-envelope"></i></span>
        <div class="form-floating">
          <input type="email" class="form-control" id="email" placeholder="Email" required>
          <label for="email">Email Address</label>
        </div>
      </div>
      <div class="mb-3 position-relative">
        <span class="input-icon"><i class="bi bi-building"></i></span>
        <div class="form-floating">
          <input type="text" class="form-control" id="business" placeholder="Business Name (Optional)">
          <label for="business">Business Name (Optional)</label>
        </div>
      </div>
      <div class="mb-3 position-relative">
        <span class="input-icon"><i class="bi bi-briefcase"></i></span>
        <div class="form-floating">
          <input type="text" class="form-control" id="position" placeholder="Position (Optional)">
          <label for="position">Position (Optional)</label>
        </div>
      </div>
      <div class="mb-3 position-relative">
        <span class="input-icon"><i class="bi bi-lock"></i></span>
        <div class="form-floating">
          <input type="password" class="form-control" id="password" placeholder="Password" required minlength="6">
          <label for="password">Password</label>
          <button type="button" class="show-pass-btn" tabindex="-1" onclick="togglePass()"><i class="bi bi-eye" id="showPassIcon"></i></button>
        </div>
      </div>
      <div class="mb-3 position-relative">
        <span class="input-icon"><i class="bi bi-lock-fill"></i></span>
        <div class="form-floating">
          <input type="password" class="form-control" id="password2" placeholder="Confirm Password" required minlength="6">
          <label for="password2">Confirm Password</label>
          <button type="button" class="show-pass-btn" tabindex="-1" onclick="togglePass2()"><i class="bi bi-eye" id="showPassIcon2"></i></button>
        </div>
      </div>
      <div class="form-check mb-2">
        <input class="form-check-input" type="checkbox" value="" id="terms" required>
        <label class="form-check-label" for="terms">
          I agree to the <a href="terms.html" style="color:#ffe066;text-decoration:underline;">Terms</a> &amp; <a href="privacy.html" style="color:#ffe066;text-decoration:underline;">Privacy Policy</a>
        </label>
      </div>
      <div id="feedback"></div>
      <button type="submit" class="btn-gold" id="submitBtn">
        <span id="submitText">Create Account</span>
        <span id="loadingSpinner" style="display: none;">
          <i class="bi bi-arrow-clockwise" style="animation: spin 1s linear infinite;"></i> Creating Account...
        </span>
      </button>
      <a href="customer-login.html" class="login-link">Already have an account? Login</a>
    </form>
  </div>
  <script>
    // decide whether we're running locally or in prod
    const API_BASE = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
      ? 'http://localhost:5050'
      : 'https://vbms-backend.onrender.com';
      
    // Show/hide password toggle (unchanged)
    function togglePass() {
      const pass = document.getElementById('password');
      const icon = document.getElementById('showPassIcon');
      pass.type = pass.type === 'password' ? 'text' : 'password';
      icon.classList.toggle('bi-eye');
      icon.classList.toggle('bi-eye-slash');
    }
    function togglePass2() {
      const pass = document.getElementById('password2');
      const icon = document.getElementById('showPassIcon2');
      pass.type = pass.type === 'password' ? 'text' : 'password';
      icon.classList.toggle('bi-eye');
      icon.classList.toggle('bi-eye-slash');
    }

    // ACTUAL registration logic
    document.getElementById('registerForm').onsubmit = async function(e){
      e.preventDefault();

      // Get UI elements
      let feedback = document.getElementById('feedback');
      const submitBtn = document.getElementById('submitBtn');
      const submitText = document.getElementById('submitText');
      const loadingSpinner = document.getElementById('loadingSpinner');

      // Clear previous feedback
      feedback.innerHTML = '';
      feedback.className = '';

      // Show loading state
      submitBtn.disabled = true;
      submitText.style.display = 'none';
      loadingSpinner.style.display = 'inline';

      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim().toLowerCase();
      const password = document.getElementById('password').value;
      const password2 = document.getElementById('password2').value;
      const business = document.getElementById('business').value;
      const position = document.getElementById('position') ? document.getElementById('position').value : "";
      // grab the hidden role input, defaulting to "client"
      const role = document.querySelector('input[name="role"]').value;

      // Reset loading state function
      function resetLoadingState() {
        submitBtn.disabled = false;
        submitText.style.display = 'inline';
        loadingSpinner.style.display = 'none';
      }

      if(password !== password2){
        feedback.innerHTML = 'Passwords do not match.';
        feedback.className = 'error-message';
        resetLoadingState();
        return;
      }
      if (!name || !email || !password) {
        feedback.innerHTML = 'All fields are required.';
        feedback.className = 'error-message';
        resetLoadingState();
        return;
      }
      try {
        console.log('Attempting registration with API_BASE:', API_BASE);
        console.log('Registration data:', { name, email, business, position, role });

        // POST to backend!
        const res = await fetch(`${API_BASE}/api/auth/register`, {
          method: 'POST',
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, email, password, business, position, role })
        });
        const data = await res.json();
        console.log('Registration response:', res.status, data);
        if (!res.ok) {
          feedback.innerHTML = data.message || 'Registration failed.';
          feedback.className = 'error-message';
          resetLoadingState();
          return;
        }

        // Success - show success message and redirect faster
        feedback.innerHTML = '✅ Account created successfully! Redirecting...';
        feedback.className = 'success-message';
        loadingSpinner.innerHTML = '<i class="bi bi-check-circle"></i> Success!';

        // Faster redirect (500ms instead of 1200ms)
        setTimeout(() => window.location.href='customer-dashboard.html', 500);
      } catch (err) {
        feedback.innerHTML = 'Network error. Please try again.';
        feedback.className = 'error-message';
        resetLoadingState();
        console.error('Registration error:', err);
      }
    }
  </script>
</body>
</html>