<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VBMS - AI Business Agent</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" integrity="sha384-XGjxtQfXaH2tnPFa9x+ruJTuLE3Aa6LhHSWRr1XeTyhezb4abCG4ccI5AkVDxqC+" crossorigin="anonymous">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="customer-theme.css" rel="stylesheet">
  <style>
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
    }

    /* Navbar styles removed - using sidebar only */
    .chat-container {
      height: calc(100vh - 120px);
      max-width: 1200px;
      margin: 2rem auto;
      background: #27272a;
      border-radius: 15px;
      border: 1px solid #333;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .chat-header {
      background: #f0b90b;
      color: #000;
      padding: 1.5rem;
      text-align: center;
      font-weight: 700;
      font-size: 1.2rem;
    }
    .chat-messages {
      flex: 1;
      padding: 2rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .message {
      max-width: 70%;
      padding: 1rem 1.5rem;
      border-radius: 20px;
      line-height: 1.5;
    }
    .message.user {
      align-self: flex-end;
      background: #f0b90b;
      color: #000;
      border-bottom-right-radius: 5px;
    }
    .message.ai {
      align-self: flex-start;
      background: #18181b;
      color: #fff;
      border: 1px solid #444;
      border-bottom-left-radius: 5px;
    }
    .message.ai::before {
      content: "ðŸ¤– ";
      margin-right: 0.5rem;
    }
    .chat-input {
      background: #18181b;
      border-top: 1px solid #333;
      padding: 1.5rem;
      display: flex;
      gap: 1rem;
    }
    .chat-input input {
      flex: 1;
      background: #27272a;
      border: 1px solid #444;
      color: #fff;
      border-radius: 25px;
      padding: 1rem 1.5rem;
      font-size: 1rem;
    }
    .chat-input input:focus {
      outline: none;
      border-color: #f0b90b;
      box-shadow: 0 0 0 0.2rem rgba(240, 185, 11, 0.25);
    }
    .send-btn {
      background: #f0b90b;
      border: none;
      color: #000;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
    }
    .send-btn:hover {
      background: #e0a800;
      transform: scale(1.05);
    }
    .quick-suggestions {
      padding: 1rem 2rem;
      border-top: 1px solid #333;
      background: #18181b;
    }
    .suggestion-btn {
      background: #333;
      border: 1px solid #555;
      color: #fff;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      margin: 0.25rem;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.9rem;
    }
    .suggestion-btn:hover {
      background: #f0b90b;
      color: #000;
      border-color: #f0b90b;
    }
    .typing-indicator {
      display: none;
      align-self: flex-start;
      background: #18181b;
      border: 1px solid #444;
      border-radius: 20px;
      padding: 1rem 1.5rem;
      margin-bottom: 1rem;
    }
    .typing-dots {
      display: flex;
      gap: 0.3rem;
    }
    .typing-dots div {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #f0b90b;
      animation: typing 1.4s infinite ease-in-out both;
    }
    .typing-dots div:nth-child(1) { animation-delay: -0.32s; }
    .typing-dots div:nth-child(2) { animation-delay: -0.16s; }
    @keyframes typing {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }
  </style>
</head>
<body>
  <!-- Sidebar Container -->
  <div id="sidebar-container"></div>

  <div class="main-content" style="margin-left: 280px;">
        <div class="chat-container">
      <!-- Chat Header -->
      <div class="chat-header">
        <i class="bi bi-robot"></i> AI Business Agent - Ask me anything about your business!
      </div>

      <!-- Chat Messages -->
      <div class="chat-messages" id="chatMessages">
        <div class="message ai">
          Hello! I'm your AI Business Agent. I can help you with:
          <br><br>
          â€¢ Business strategy and planning<br>
          â€¢ Marketing and customer retention<br>
          â€¢ Operations optimization<br>
          â€¢ Financial planning and analysis<br>
          â€¢ Staff management tips<br>
          â€¢ Technology recommendations<br>
          <br>
          What would you like to discuss today?
        </div>
      </div>

      <!-- Typing Indicator -->
      <div class="typing-indicator" id="typingIndicator">
        <div class="typing-dots">
          <div></div>
          <div></div>
          <div></div>
        </div>
      </div>

      <!-- Quick Suggestions -->
      <div class="quick-suggestions">
        <small style="color: #a1a1aa; display: block; margin-bottom: 0.5rem;">Quick suggestions:</small>
        <button class="suggestion-btn" onclick="sendSuggestion('How can I increase customer retention?')">
          How can I increase customer retention?
        </button>
        <button class="suggestion-btn" onclick="sendSuggestion('What are good marketing strategies for restaurants?')">
          Marketing strategies for restaurants
        </button>
        <button class="suggestion-btn" onclick="sendSuggestion('How to manage inventory efficiently?')">
          Inventory management tips
        </button>
        <button class="suggestion-btn" onclick="sendSuggestion('Ways to reduce operational costs')">
          Reduce operational costs
        </button>
        <button class="suggestion-btn" onclick="sendSuggestion('Staff scheduling best practices')">
          Staff scheduling tips
        </button>
      </div>

      <!-- Chat Input -->
      <div class="chat-input">
        <input type="text" id="messageInput" placeholder="Type your business question here..." maxlength="500">
        <button class="send-btn" onclick="sendMessage()">
          <i class="bi bi-send-fill"></i>
        </button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="auth.js"></script>
  <script src="theme-manager.js"></script>
  <script src="load-sidebar.js"></script>
  <script>
    // Authentication check
    document.addEventListener('DOMContentLoaded', function() {
      const user = vbmsAuth.getCurrentUser();
      if (!user || !vbmsAuth.getToken()) {
        window.location.href = 'customer-login.html';
        return;
      }

      // Role-based access control
      const userRole = vbmsAuth.getCurrentRole();
      if (userRole !== 'customer' && userRole !== 'client') {
        alert('Access Denied: Customer access required');
        window.location.href = vbmsAuth.getRoleRedirectUrl();
        return;
      }

      console.log('AI Chat loaded for:', user.name);

      // Focus input
      document.getElementById('messageInput').focus();

      // Enter key to send
      document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });
    });

    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const message = input.value.trim();

      if (!message) return;

      // Add user message
      addMessage(message, 'user');
      input.value = '';

      // Show typing indicator
      showTyping();

      // Get AI response
      try {
        const response = await generateAIResponse(message);
        hideTyping();
        addMessage(response, 'ai');
      } catch (error) {
        hideTyping();
        addMessage("Sorry, I'm having trouble connecting right now. Please try again later.", 'ai');
      }
    }

    function sendSuggestion(suggestion) {
      document.getElementById('messageInput').value = suggestion;
      sendMessage();
    }

    function addMessage(text, sender) {
      const messagesContainer = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}`;
      messageDiv.textContent = text;

      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function showTyping() {
      document.getElementById('typingIndicator').style.display = 'block';
      const messagesContainer = document.getElementById('chatMessages');
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function hideTyping() {
      document.getElementById('typingIndicator').style.display = 'none';
    }

    async function generateAIResponse(message) {
      try {
        // Show typing indicator
        document.querySelector('.typing-indicator').style.display = 'block';

        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ 
            message: message,
            context: 'business assistant'
          })
        });

        if (!response.ok) {
          throw new Error('Failed to get AI response');
        }

        const data = await response.json();

        // Add AI response to chat
        addMessage(data.response, 'ai');

        // Show fallback notice if API failed
        if (data.fallback) {
          setTimeout(() => {
            addMessage("ðŸ’¡ Tip: You can ask me about sales strategies, marketing, inventory management, customer service, team building, and financial planning!", 'ai');
          }, 1000);
        }

      } catch (error) {
        console.error('Error calling AI API:', error);

        // Fallback to keyword-based responses
        let fallbackResponse = "I'm experiencing some technical difficulties. Let me try to help with a basic response: ";

        // Simple keyword-based fallback responses
        if (message.toLowerCase().includes('sales') || message.toLowerCase().includes('revenue')) {
          fallbackResponse += "For sales growth, focus on customer retention, upselling, pricing optimization, and improving your sales funnel conversion rates.";
        } else if (message.toLowerCase().includes('marketing')) {
          fallbackResponse += "For marketing, consider digital marketing, email campaigns, local networking, referral programs, and SEO optimization.";
        } else if (message.toLowerCase().includes('inventory')) {
          fallbackResponse += "For inventory management, implement just-in-time ordering, ABC analysis, automated reorder points, and regular cycle counting.";
        } else if (message.toLowerCase().includes('customer')) {
          fallbackResponse += "For customer service, focus on quick responses, staff training, feedback systems, personalization, and follow-up procedures.";
        } else {
          fallbackResponse = "I'm having technical difficulties right now. Please try again in a moment, or feel free to ask about sales, marketing, inventory, customer service, or team management!";
        }

        addMessage(fallbackResponse, 'ai');
      } finally {
        // Hide typing indicator
        document.querySelector('.typing-indicator').style.display = 'none';
      }
    }

    function logout() {
      vbmsAuth.logout();
    }
  </script>
</body>
</html>