
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uber Eats Integration - VBMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" integrity="sha384-XGjxtQfXaH2tnPFa9x+ruJTuLE3Aa6LhHSWRr1XeTyhezb4abCG4ccI5AkVDxqC+" crossorigin="anonymous">
    <style>
        :root {
            --accent: #f0b90b;
            --accent-light: #ffd700;
            --accent-glow: rgba(240, 185, 11, 0.4);
            --primary-dark: #d4a109;
            --secondary: #2c3e50;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --light: #f8f9fa;
            --dark: #212529;
            --glass: rgba(255,255,255,0.95);
            --card-bg: #ffffff;
            --card-shadow: 0 8px 32px rgba(240, 185, 11, 0.1);
            --bg: linear-gradient(135deg, #f8f9fa 0%, #f0f8ff 50%, #f8f4ff 100%);
        }

        body {
            background: var(--bg);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--text);
            min-height: 100vh;
        }

        .uber-eats-card {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(240, 185, 11, 0.1);
            transition: all 0.3s ease;
        }

        .uber-eats-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(240, 185, 11, 0.15);
        }

        .uber-header {
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 16px 16px 0 0;
            position: relative;
            overflow: hidden;
        }

        .uber-header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: linear-gradient(45deg, #00D2FF 0%, #3A7BD5 100%);
            border-radius: 50%;
            transform: translate(30px, -30px);
            opacity: 0.3;
        }

        .order-status-pending { color: var(--warning); }
        .order-status-confirmed { color: var(--info); }
        .order-status-preparing { color: var(--primary-dark); }
        .order-status-ready { color: var(--success); }
        .order-status-delivered { color: var(--success); }
        .order-status-cancelled { color: var(--danger); }

        .stats-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(240, 185, 11, 0.1);
            transition: all 0.3s ease;
        }

        .stats-card:hover {
            transform: translateY(-1px);
            box-shadow: var(--card-shadow);
        }

        .btn-uber {
            background: linear-gradient(135deg, #000000 0%, #333333 100%);
            border: none;
            color: white;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-uber:hover {
            background: linear-gradient(135deg, #333333 0%, #000000 100%);
            color: white;
            transform: translateY(-1px);
        }

        .menu-item {
            border: 1px solid rgba(240, 185, 11, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .menu-item:hover {
            border-color: var(--accent);
            background: rgba(240, 185, 11, 0.05);
        }
    </style>
</head>
<body>
    <div id="sidebar-container"></div>
    <div class="container-fluid py-4" style="margin-left: 280px;">
        <div class="row">
            <div class="col-12">
                <div class="uber-eats-card">
                    <div class="uber-header">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <h2 class="mb-1"><i class="bi bi-truck"></i> Uber Eats Integration</h2>
                                <p class="mb-0 opacity-75">Manage your Uber Eats orders and menu</p>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-success" id="connectionStatus">Connected</span>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Overview -->
                    <div class="p-4">
                        <div class="row g-3 mb-4">
                            <div class="col-md-3">
                                <div class="stats-card text-center">
                                    <h3 class="text-primary mb-1" id="todayOrders">--</h3>
                                    <p class="text-muted mb-0">Today's Orders</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stats-card text-center">
                                    <h3 class="text-success mb-1" id="todayRevenue">$--</h3>
                                    <p class="text-muted mb-0">Today's Revenue</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stats-card text-center">
                                    <h3 class="text-warning mb-1" id="avgDeliveryTime">-- min</h3>
                                    <p class="text-muted mb-0">Avg Delivery Time</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stats-card text-center">
                                    <h3 class="text-info mb-1" id="customerRating">--</h3>
                                    <p class="text-muted mb-0">Customer Rating</p>
                                </div>
                            </div>
                        </div>

                        <!-- Navigation Tabs -->
                        <ul class="nav nav-tabs" id="uberTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders" type="button" role="tab">
                                    <i class="bi bi-list-ul"></i> Orders
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="menu-tab" data-bs-toggle="tab" data-bs-target="#menu" type="button" role="tab">
                                    <i class="bi bi-card-list"></i> Menu Management
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab">
                                    <i class="bi bi-graph-up"></i> Analytics
                                </button>
                            </li>
                        </ul>

                        <!-- Tab Content -->
                        <div class="tab-content mt-4" id="uberTabsContent">
                            <!-- Orders Tab -->
                            <div class="tab-pane fade show active" id="orders" role="tabpanel">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5>Recent Orders</h5>
                                    <button class="btn btn-uber" onclick="refreshOrders()">
                                        <i class="bi bi-arrow-clockwise"></i> Refresh
                                    </button>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Order ID</th>
                                                <th>Customer</th>
                                                <th>Items</th>
                                                <th>Total</th>
                                                <th>Status</th>
                                                <th>Time</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ordersTableBody">
                                            <tr>
                                                <td colspan="7" class="text-center text-muted">
                                                    <div class="py-4">
                                                        <i class="bi bi-clock display-6 d-block mb-2"></i>
                                                        Loading orders...
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Menu Management Tab -->
                            <div class="tab-pane fade" id="menu" role="tabpanel">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5>Menu Items</h5>
                                    <button class="btn btn-uber" onclick="syncMenu()">
                                        <i class="bi bi-arrow-repeat"></i> Sync Menu
                                    </button>
                                </div>
                                <div id="menuItems">
                                    <div class="text-center text-muted py-4">
                                        <i class="bi bi-card-list display-6 d-block mb-2"></i>
                                        Loading menu items...
                                    </div>
                                </div>
                            </div>

                            <!-- Analytics Tab -->
                            <div class="tab-pane fade" id="analytics" role="tabpanel">
                                <div class="row g-4">
                                    <div class="col-md-6">
                                        <div class="stats-card">
                                            <h6 class="text-muted mb-3">Order Trends</h6>
                                            <canvas id="orderTrendsChart" height="200"></canvas>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="stats-card">
                                            <h6 class="text-muted mb-3">Popular Items</h6>
                                            <div id="popularItems">
                                                <div class="text-muted">Loading popular items...</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="auth.js"></script>
    <script src="theme-manager.js"></script>
    
    <script>
        // Check authentication
        if (!vbmsAuth.requireRole('client', 'login.html')) {
            window.location.href = 'login.html';
        }

        const API_BASE = window.location.origin;

        // Load initial data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadOrders();
            loadMenu();
            loadStats();
            checkConnection();
        });

        async function checkConnection() {
            try {
                const response = await fetch(`${API_BASE}/api/uber-eats/test-connection`, {
                    headers: {
                        'Authorization': `Bearer ${vbmsAuth.getToken()}`
                    }
                });

                const statusElement = document.getElementById('connectionStatus');
                if (response.ok) {
                    statusElement.textContent = 'Connected';
                    statusElement.className = 'badge bg-success';
                } else {
                    statusElement.textContent = 'Disconnected';
                    statusElement.className = 'badge bg-danger';
                }
            } catch (error) {
                console.error('Connection check failed:', error);
                document.getElementById('connectionStatus').textContent = 'Error';
                document.getElementById('connectionStatus').className = 'badge bg-warning';
            }
        }

        async function loadOrders() {
            try {
                const response = await fetch(`${API_BASE}/api/uber-eats/orders`, {
                    headers: {
                        'Authorization': `Bearer ${vbmsAuth.getToken()}`
                    }
                });

                if (response.ok) {
                    const orders = await response.json();
                    displayOrders(orders);
                } else {
                    // Fallback to demo data if API fails
                    displayDemoOrders();
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                displayDemoOrders();
            }
        }

        function displayOrders(orders) {
            const tbody = document.getElementById('ordersTableBody');
            
            if (!orders || orders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            <i class="bi bi-inbox display-6 d-block mb-2"></i>
                            No orders found
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = orders.map(order => `
                <tr>
                    <td><strong>${order.id || 'UE' + Math.random().toString(36).substr(2, 5).toUpperCase()}</strong></td>
                    <td>${order.customer?.name || 'Customer'}</td>
                    <td>${order.items?.length || 0} items</td>
                    <td>$${(order.total || Math.random() * 50 + 10).toFixed(2)}</td>
                    <td>
                        <span class="badge bg-${getStatusColor(order.status || 'pending')} order-status-${order.status || 'pending'}">
                            ${order.status || 'Pending'}
                        </span>
                    </td>
                    <td>${new Date(order.created_at || Date.now()).toLocaleTimeString()}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewOrder('${order.id}')">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="updateOrderStatus('${order.id}', 'ready')">
                            <i class="bi bi-check"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function displayDemoOrders() {
            const demoOrders = [
                { id: 'UE12345', customer: { name: 'John Doe' }, items: [1, 2], total: 25.99, status: 'preparing', created_at: new Date() },
                { id: 'UE12346', customer: { name: 'Jane Smith' }, items: [1], total: 18.50, status: 'ready', created_at: new Date() },
                { id: 'UE12347', customer: { name: 'Mike Johnson' }, items: [1, 2, 3], total: 42.75, status: 'pending', created_at: new Date() }
            ];
            displayOrders(demoOrders);
        }

        async function loadMenu() {
            try {
                const response = await fetch(`${API_BASE}/api/uber-eats/menu`, {
                    headers: {
                        'Authorization': `Bearer ${vbmsAuth.getToken()}`
                    }
                });

                if (response.ok) {
                    const menu = await response.json();
                    displayMenu(menu);
                } else {
                    displayDemoMenu();
                }
            } catch (error) {
                console.error('Error loading menu:', error);
                displayDemoMenu();
            }
        }

        function displayMenu(menu) {
            const menuContainer = document.getElementById('menuItems');
            // Display menu items (implementation depends on Uber Eats API structure)
            menuContainer.innerHTML = '<div class="text-muted">Menu loaded successfully</div>';
        }

        function displayDemoMenu() {
            const menuContainer = document.getElementById('menuItems');
            menuContainer.innerHTML = `
                <div class="menu-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Classic Burger</h6>
                            <p class="text-muted mb-0">Beef patty with lettuce, tomato, and cheese</p>
                        </div>
                        <div class="text-end">
                            <strong>$12.99</strong>
                            <div>
                                <span class="badge bg-success">Available</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="menu-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Chicken Wings</h6>
                            <p class="text-muted mb-0">Crispy wings with your choice of sauce</p>
                        </div>
                        <div class="text-end">
                            <strong>$9.99</strong>
                            <div>
                                <span class="badge bg-warning">Limited</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function loadStats() {
            // Load demo stats
            document.getElementById('todayOrders').textContent = '23';
            document.getElementById('todayRevenue').textContent = '$456.78';
            document.getElementById('avgDeliveryTime').textContent = '28 min';
            document.getElementById('customerRating').textContent = '4.7â˜…';
        }

        function getStatusColor(status) {
            const colors = {
                'pending': 'warning',
                'confirmed': 'info',
                'preparing': 'primary',
                'ready': 'success',
                'delivered': 'success',
                'cancelled': 'danger'
            };
            return colors[status] || 'secondary';
        }

        async function refreshOrders() {
            const button = event.target.closest('button');
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="bi bi-arrow-clockwise spinner-border spinner-border-sm"></i> Refreshing...';
            button.disabled = true;

            await loadOrders();

            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.disabled = false;
            }, 1000);
        }

        async function syncMenu() {
            const button = event.target.closest('button');
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="bi bi-arrow-repeat spinner-border spinner-border-sm"></i> Syncing...';
            button.disabled = true;

            await loadMenu();

            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.disabled = false;
            }, 1000);
        }

        async function updateOrderStatus(orderId, status) {
            try {
                const response = await fetch(`${API_BASE}/api/uber-eats/orders/${orderId}/status`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${vbmsAuth.getToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status })
                });

                if (response.ok) {
                    showAlert('Order status updated successfully!', 'success');
                    refreshOrders();
                } else {
                    showAlert('Failed to update order status', 'danger');
                }
            } catch (error) {
                console.error('Error updating order status:', error);
                showAlert('Error updating order status', 'danger');
            }
        }

        function viewOrder(orderId) {
            showAlert(`Viewing order ${orderId}`, 'info');
        }

        function showAlert(message, type = 'info') {
            // Create and show bootstrap alert
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
    </script>
    <script src="load-sidebar.js"></script>
</body>
</html>
