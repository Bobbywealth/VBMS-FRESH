<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>VBMS Unified Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
        :root {
            --accent: #f0b90b;
            --accent-light: #ffd700;
            --accent-glow: rgba(240, 185, 11, 0.4);
            --primary-dark: #d4a109;
            --secondary: #2c3e50;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --purple: #a855f7;
            --cyan: #06b6d4;
            --light: #f8f9fa;
            --dark: #212529;
            --glass: rgba(255,255,255,0.95);
            --glass-glow: rgba(240, 185, 11, 0.15);
            --border: #e9ecef;
            --text: #212529;
            --text-muted: #6c757d;
            --card-bg: #ffffff;
            --card-shadow: 0 8px 32px rgba(240, 185, 11, 0.1);
            --bg: linear-gradient(135deg, #f8f9fa 0%, #f0f8ff 50%, #f8f4ff 100%);
            --sidebar-bg: rgba(255,255,255,0.98);
            --sidebar-link: #333;
            --sidebar-link-active: #000;
            --badge-due: #f0a500;
            --badge-new: #21a1ff;
            --task-done: #28c028;
            --card-shadow-heavy: 0 0 22px 2px rgba(240,185,11,.20);
        }

        /* Light theme - Enhanced */
        [data-theme="light"] {
            --bg: linear-gradient(135deg, #ffffff 0%, #f8fafc 30%, #e2e8f0 100%);
            --light: #1a202c;
            --dark: #ffffff;
            --text: #2d3748;
            --text-muted: #718096;
            --card-bg: rgba(255, 255, 255, 0.95);
            --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            --border: #e2e8f0;
            --glass: rgba(255, 255, 255, 0.95);
            --glass-glow: rgba(240, 185, 11, 0.12);
            --sidebar-bg: rgba(255, 255, 255, 0.98);
            --sidebar-link: #4a5568;
            --sidebar-link-active: #1a202c;
            --accent: #f59e0b;
            --accent-light: #fbbf24;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --purple: #8b5cf6;
            --cyan: #06b6d4;
        }

        /* Dark theme - Modern Black/Gray with Energy */
        [data-theme="dark"] {
            --bg: linear-gradient(135deg, #000000 0%, #0a0a0a 25%, #1a1a1a 50%, #0f0f0f 100%);
            --light: #ffffff;
            --dark: #000000;
            --text: #ffffff;
            --text-muted: #a1a1aa;
            --card-bg: rgba(20, 20, 20, 0.95);
            --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.8), 0 0 20px rgba(240, 185, 11, 0.15);
            --border: rgba(64, 64, 64, 0.4);
            --glass: rgba(18, 18, 18, 0.95);
            --glass-glow: rgba(240, 185, 11, 0.2);
            --sidebar-bg: rgba(12, 12, 12, 0.98);
            --sidebar-link: #d4d4d8;
            --sidebar-link-active: #ffffff;
            --accent: #f0b90b;
            --accent-light: #ffd700;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --purple: #a855f7;
            --cyan: #06b6d4;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            overflow-x: hidden;
            transition: all 0.3s ease;
            position: relative;
            min-height: 100vh;
        }
        /* Enhanced Background Animation */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            background: 
                radial-gradient(circle at 20% 30%, rgba(240, 185, 11, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(59, 130, 246, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(168, 85, 247, 0.03) 0%, transparent 60%);
            animation: enhancedGlow 25s ease-in-out infinite;
        }

        [data-theme="light"] body::before {
            background: 
                radial-gradient(circle at 20% 30%, rgba(240, 185, 11, 0.12) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(59, 130, 246, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(168, 85, 247, 0.06) 0%, transparent 60%);
        }

        /* Dark theme animated background */
        [data-theme="dark"] body::before {
            background: 
                radial-gradient(circle at 15% 25%, rgba(240, 185, 11, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 85% 75%, rgba(128, 128, 128, 0.06) 0%, transparent 60%),
                radial-gradient(circle at 50% 50%, rgba(64, 64, 64, 0.05) 0%, transparent 70%),
                radial-gradient(circle at 70% 20%, rgba(240, 185, 11, 0.04) 0%, transparent 55%);
            animation: darkThemeGlow 25s ease-in-out infinite;
        }

        /* Floating particles effect for dark theme */
        [data-theme="dark"] body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background:
                radial-gradient(circle 1.5px at 10% 20%, rgba(240, 185, 11, 0.4) 0%, transparent 50%),
                radial-gradient(circle 1px at 90% 30%, rgba(128, 128, 128, 0.3) 0%, transparent 50%),
                radial-gradient(circle 1px at 30% 80%, rgba(240, 185, 11, 0.2) 0%, transparent 50%),
                radial-gradient(circle 0.5px at 70% 60%, rgba(96, 96, 96, 0.2) 0%, transparent 50%),
                radial-gradient(circle 1px at 20% 70%, rgba(255, 215, 0, 0.15) 0%, transparent 50%);
            animation: floatingParticles 20s linear infinite;
        }

        @keyframes enhancedGlow {
            0%, 100% {
                opacity: 0.6;
                transform: rotate(0deg) scale(1);
            }
            33% {
                opacity: 0.8;
                transform: rotate(120deg) scale(1.05);
            }
            66% {
                opacity: 0.7;
                transform: rotate(240deg) scale(0.95);
            }
        }

        @keyframes darkThemeGlow {
            0%, 100% {
                opacity: 0.8;
                transform: rotate(0deg) scale(1);
            }
            25% {
                opacity: 1;
                transform: rotate(90deg) scale(1.1);
            }
            50% {
                opacity: 0.9;
                transform: rotate(180deg) scale(1.05);
            }
            75% {
                opacity: 1;
                transform: rotate(270deg) scale(1.08);
            }
        }

        @keyframes floatingParticles {
            0% {
                transform: translateY(0px) rotate(0deg);
                opacity: 1;
            }
            25% {
                transform: translateY(-10px) rotate(90deg);
                opacity: 0.8;
            }
            50% {
                transform: translateY(-5px) rotate(180deg);
                opacity: 0.6;
            }
            75% {
                transform: translateY(-15px) rotate(270deg);
                opacity: 0.9;
            }
            100% {
                transform: translateY(0px) rotate(360deg);
                opacity: 1;
            }
        }

/* Sidebar CSS removed - now handled by admin-sidebar.html */

.main-content {
  margin-left: 320px;
  padding: 30px;
  min-height: 100vh;
  background: transparent;
  transition: all 0.3s ease;
}

/* Mobile content adjustments */
@media (max-width: 1024px) {
  .main-content {
    margin-left: 280px;
    padding: 25px;
  }
}

@media (max-width: 768px) {
  .main-content {
    margin-left: 0;
    padding: 80px 15px 15px 15px;
  }
}

@media (max-width: 480px) {
  .main-content {
    padding: 75px 10px 10px 10px;
  }
}

@media (max-width: 320px) {
  .main-content {
    padding: 70px 8px 8px 8px;
  }
}
/* Header Styling */
.header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 30px;
  padding: 20px 0;
}

.header-left h1 {
  font-size: 2.5rem;
  font-weight: 700;
  color: var(--text);
  margin: 0 0 10px 0;
  display: flex;
  align-items: center;
  gap: 15px;
}

.header-left h1 i {
  color: var(--accent);
  font-size: 2rem;
}

.datetime-info {
  display: flex;
  gap: 20px;
  margin-top: 8px;
}

.current-date, .current-time {
  color: var(--text-muted);
  font-size: 0.95rem;
  font-weight: 500;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 15px;
}

/* Notifications */
.notifications-container {
  position: relative;
}

.notification-btn {
  background: var(--glass);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 12px;
  color: var(--text);
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
}

.notification-btn:hover {
  background: var(--glass-glow);
  transform: translateY(-2px);
}

.notification-badge {
  position: absolute;
  top: -8px;
  right: -8px;
  background: var(--danger);
  color: white;
  border-radius: 50%;
  padding: 2px 6px;
  font-size: 0.7rem;
  font-weight: 600;
  min-width: 18px;
  text-align: center;
}

.notifications-dropdown {
  position: absolute;
  top: 100%;
  right: 0;
  background: var(--glass);
  backdrop-filter: blur(15px);
  border: 1px solid var(--border);
  border-radius: 12px;
  box-shadow: var(--card-shadow);
  width: 350px;
  max-height: 400px;
  overflow-y: auto;
  display: none;
  z-index: 1000;
  margin-top: 8px;
}

.notifications-dropdown.show {
  display: block;
}

.notifications-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  border-bottom: 1px solid var(--border);
}

.notifications-header h4 {
  margin: 0;
  color: var(--text);
  font-size: 1.1rem;
}

.mark-all-read {
  background: none;
  border: none;
  color: var(--accent);
  font-size: 0.85rem;
  cursor: pointer;
  font-weight: 500;
}

.notifications-list {
  max-height: 300px;
  overflow-y: auto;
}

.notification-item {
  display: flex;
  align-items: flex-start;
  padding: 15px 20px;
  border-bottom: 1px solid var(--border);
  transition: all 0.3s ease;
}

.notification-item:hover {
  background: var(--glass-glow);
}

.notification-item:last-child {
  border-bottom: none;
}

.notification-icon {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 12px;
  flex-shrink: 0;
}

.notification-icon.payment { background: rgba(34, 197, 94, 0.2); color: var(--success); }
.notification-icon.order { background: rgba(59, 130, 246, 0.2); color: var(--info); }
.notification-icon.system { background: rgba(168, 85, 247, 0.2); color: var(--purple); }

.notification-content {
  flex: 1;
}

.notification-title {
  font-weight: 600;
  color: var(--text);
  margin-bottom: 2px;
  font-size: 0.9rem;
}

.notification-message {
  color: var(--text-muted);
  font-size: 0.85rem;
  margin-bottom: 4px;
}

.notification-time {
  color: var(--accent);
  font-size: 0.75rem;
  font-weight: 500;
}

/* User Menu */
.user-menu {
  position: relative;
}

.user-btn {
  background: var(--glass);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 8px 15px;
  display: flex;
  align-items: center;
  gap: 10px;
  color: var(--text);
  cursor: pointer;
  transition: all 0.3s ease;
}

.user-btn:hover {
  background: var(--glass-glow);
  transform: translateY(-2px);
}

.user-avatar {
  width: 32px;
  height: 32px;
  border-radius: 8px;
  object-fit: cover;
}

.user-dropdown {
  position: absolute;
  top: 100%;
  right: 0;
  background: var(--glass);
  backdrop-filter: blur(15px);
  border: 1px solid var(--border);
  border-radius: 12px;
  box-shadow: var(--card-shadow);
  min-width: 180px;
  padding: 8px 0;
  display: none;
  z-index: 1000;
  margin-top: 8px;
}

.user-dropdown.show {
  display: block;
}

.user-dropdown a,
.user-dropdown button {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 15px;
  color: var(--text);
  text-decoration: none;
  background: none;
  border: none;
  width: 100%;
  text-align: left;
  cursor: pointer;
  transition: all 0.3s ease;
}

.user-dropdown a:hover,
.user-dropdown button:hover {
  background: var(--glass-glow);
  color: var(--accent);
}

.dropdown-divider {
  height: 1px;
  background: var(--border);
  margin: 5px 0;
}

/* Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  background: var(--glass);
  backdrop-filter: blur(15px);
  padding: 25px;
  border-radius: 20px;
  border: 1px solid var(--border);
  box-shadow: var(--card-shadow);
  transition: all 0.4s ease;
  position: relative;
  overflow: hidden;
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--accent), var(--accent-light));
  opacity: 0.8;
}

.stat-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 15px 40px rgba(240, 185, 11, 0.2);
  border-color: var(--accent);
}

.stat-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 15px;
}

.stat-info {
  flex: 1;
}

.stat-number {
  font-size: 2.2rem;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 5px;
  line-height: 1;
}

.stat-trend {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 0.85rem;
  font-weight: 600;
}

.stat-card[data-trend="up"] .stat-trend {
  color: var(--success);
}

.stat-card[data-trend="down"] .stat-trend {
  color: var(--danger);
}

.stat-card[data-trend="stable"] .stat-trend {
  color: var(--info);
}

.stat-icon {
  font-size: 2.5rem;
  color: var(--accent);
  opacity: 0.7;
  transition: all 0.3s ease;
}

.stat-card:hover .stat-icon {
  opacity: 1;
  transform: scale(1.1);
  color: var(--accent-light);
}

/* Enhanced Card Stack Animations */
.stat-card {
    position: relative;
    overflow: hidden;
}

.stat-card::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(240, 185, 11, 0.2), transparent);
    transition: left 0.6s ease;
}

.stat-card:hover::after {
    left: 100%;
}

/* Staggered Card Entrance Animation */
.stats-grid .stat-card:nth-child(1) { animation: slideInUp 0.6s ease 0.1s both; }
.stats-grid .stat-card:nth-child(2) { animation: slideInUp 0.6s ease 0.2s both; }
.stats-grid .stat-card:nth-child(3) { animation: slideInUp 0.6s ease 0.3s both; }
.stats-grid .stat-card:nth-child(4) { animation: slideInUp 0.6s ease 0.4s both; }
.stats-grid .stat-card:nth-child(5) { animation: slideInUp 0.6s ease 0.5s both; }
.stats-grid .stat-card:nth-child(6) { animation: slideInUp 0.6s ease 0.6s both; }

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(30px) scale(0.9);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* Enhanced Pulse Animation for Action Items */
.pulse-dot {
    width: 8px;
    height: 8px;
    background: var(--cyan);
    border-radius: 50%;
    animation: enhancedPulse 2s infinite;
    position: relative;
}

.pulse-dot::before {
    content: '';
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: var(--cyan);
    animation: pulseRing 2s infinite;
}

@keyframes enhancedPulse {
    0%, 100% { 
        opacity: 1; 
        transform: scale(1);
    }
    50% { 
        opacity: 0.7; 
        transform: scale(1.2);
    }
}

@keyframes pulseRing {
    0% {
        transform: scale(1);
        opacity: 0.8;
    }
    100% {
        transform: scale(2.5);
        opacity: 0;
    }
}

/* Floating Glow Effect for Important Cards */
.important-card {
    position: relative;
}

.important-card::before {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    background: linear-gradient(45deg, var(--accent), var(--accent-light), var(--accent));
    border-radius: inherit;
    opacity: 0;
    z-index: -1;
    transition: opacity 0.3s ease;
    animation: borderGlow 3s ease-in-out infinite;
}

.important-card:hover::before {
    opacity: 0.7;
}

@keyframes borderGlow {
    0%, 100% { 
        opacity: 0.3;
        filter: blur(5px);
    }
    50% { 
        opacity: 0.8;
        filter: blur(10px);
    }
}

.stat-label {
  color: var(--text-muted);
  font-size: 0.9rem;
  font-weight: 500;
  margin-bottom: 15px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.stat-progress {
  height: 4px;
  background: rgba(0, 0, 0, 0.1);
  border-radius: 2px;
  overflow: hidden;
}

[data-theme="dark"] .stat-progress {
  background: rgba(255, 255, 255, 0.1);
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), var(--accent-light));
  border-radius: 2px;
  transition: width 1s ease;
  position: relative;
}

.progress-fill::after {
  content: '';
  position: absolute;
  top: 0;
  right: 0;
  width: 20px;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3));
  animation: shimmer 2s infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-20px); }
  100% { transform: translateX(20px); }
}

/* Admin Management Card */
.admin-management-card {
    background: var(--glass);
    backdrop-filter: blur(15px);
    padding: 25px;
    border-radius: 20px;
    border: 1px solid var(--border);
    box-shadow: var(--card-shadow);
    transition: all 0.4s ease;
    position: relative;
    overflow: hidden;
    margin-bottom: 25px;
}

.admin-management-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--accent), var(--accent-light));
    opacity: 0.8;
}

.admin-management-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 40px rgba(240, 185, 11, 0.2);
    border-color: var(--accent);
}

.admin-management-card h3 {
    color: var(--accent);
    font-size: 1.4rem;
    font-weight: 700;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* Filter Section */
.filter-section {
    display: flex;
    gap: 15px;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.filter-section select,
.filter-section input {
    background: var(--glass);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px 12px;
    color: var(--text);
    min-width: 150px;
}

.filter-section select:focus,
.filter-section input:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(240, 185, 11, 0.1);
}

/* Admin Table */
.admin-table {
    background: var(--glass);
    border-radius: 15px;
    overflow: hidden;
    border: 1px solid var(--border);
    box-shadow: var(--card-shadow);
}

.admin-table table {
    margin: 0;
}

.admin-table th {
    background: var(--accent);
    color: #000;
    font-weight: 700;
    padding: 15px;
    border: none;
}

.admin-table td {
    padding: 12px 15px;
    border-bottom: 1px solid var(--border);
    color: var(--text);
}

.admin-table tr:last-child td {
    border-bottom: none;
}

.admin-table tr:hover {
    background: var(--glass-glow);
}

/* Admin Avatar */
.admin-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), var(--accent-light));
    display: flex;
    align-items: center;
    justify-content: center;
    color: #000;
    font-weight: 700;
    font-size: 1rem;
    margin-right: 10px;
}

/* Enhanced Badge Styling */
.badge-main-admin {
    background: linear-gradient(135deg, var(--danger), #dc2626);
    color: white;
}

.badge-admin {
    background: linear-gradient(135deg, var(--accent), var(--accent-light));
    color: #000;
}

.badge-support {
    background: var(--info);
    color: white;
}

.badge-active {
    background: var(--success);
    color: white;
}

.badge-inactive {
    background: var(--danger);
    color: white;
}

.badge-full {
    background: var(--success);
    color: white;
}

.badge-limited {
    background: var(--warning);
    color: white;
}

.badge-readonly {
    background: var(--text-muted);
    color: white;
}

/* Action Buttons */
.action-btn {
    background: var(--glass);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 6px 12px;
    color: var(--text);
    text-decoration: none;
    transition: all 0.3s ease;
    font-size: 0.85rem;
    margin-right: 5px;
}

.action-btn:hover {
    background: var(--glass-glow);
    color: var(--accent);
    border-color: var(--accent);
    text-decoration: none;
}

.action-btn.btn-danger {
    background: var(--danger);
    color: white;
    border-color: var(--danger);
}

.action-btn.btn-danger:hover {
    background: #dc2626;
    color: white;
    border-color: #dc2626;
}

/* Dark theme card enhancements for admin section */
[data-theme="dark"] .admin-management-card {
    border: 1px solid rgba(64, 64, 64, 0.4);
    box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.8),
        0 0 20px rgba(240, 185, 11, 0.1),
        inset 0 1px 0 rgba(128, 128, 128, 0.1);
}

[data-theme="dark"] .admin-management-card:hover {
    transform: translateY(-5px);
    box-shadow: 
        0 12px 40px rgba(0, 0, 0, 0.9),
        0 0 30px rgba(240, 185, 11, 0.2),
        0 0 10px rgba(255, 215, 0, 0.15),
        inset 0 1px 0 rgba(240, 185, 11, 0.2);
    border-color: rgba(240, 185, 11, 0.3);
}
#toggleSidebar { padding:.25rem .55rem }

/* Mini stats bar */
.mini-stats-bar {
  display:flex;
  align-items:center;
  gap:2rem;
  background:var(--card-bg);
  border-radius:24px;
  box-shadow: var(--card-shadow);
  margin-bottom:.6rem;
  padding:.4rem 2rem;
  font-size:1.05rem;
  border: 1px solid var(--border);
}

/* Dark theme mini stats bar */
[data-theme="dark"] .mini-stats-bar {
  background: linear-gradient(90deg, rgba(20, 20, 20, 0.95), rgba(32, 32, 32, 0.8));
  border: 1px solid rgba(64, 64, 64, 0.4);
  box-shadow: 
    0 4px 20px rgba(0, 0, 0, 0.6),
    0 0 15px rgba(240, 185, 11, 0.1),
    inset 0 1px 0 rgba(128, 128, 128, 0.2);
}

[data-theme="dark"] .mini-stats-bar .stat i {
  color: var(--accent-light);
  text-shadow: 0 0 10px rgba(240, 185, 11, 0.5);
}
.mini-stats-bar .stat {
  display:flex;align-items:center;gap:.5rem;
  font-weight:600;
  color:var(--accent);
}
/* Quick actions */
.quick-actions { display:flex;gap:1rem;flex-wrap:wrap;margin-bottom:1.4rem }
.quick-actions button {
  background: var(--accent);
  border:none;
  color:#000;
  font-weight:700;
  border-radius:6px;
  padding:.42rem 1rem;
  display:flex;gap:.45rem;align-items:center
}
.quick-actions button:hover { background:#d4a906 }
.quick-actions i { font-size:1.25rem }

/* Card, stats, sections */
.card-section {
  background: var(--card-bg);
  border:1px solid var(--border);
  border-radius:12px;
  padding:1.2rem 1.5rem;
  margin-bottom:1.6rem;
  box-shadow: var(--card-shadow);
  backdrop-filter: blur(10px);
}
.card-section>h2 { font-size:1.1rem;font-weight:700;color:var(--accent);margin-bottom:.9rem }
.stats-grid {
  display: grid;
  gap: 1rem;
  grid-template-columns: repeat(auto-fit,minmax(180px,1fr));
  align-items: stretch;
}
.stat-card {
  background: var(--card-bg);
  border-radius:10px;
  padding:1.3rem 1.2rem 1.2rem 1.2rem;
  box-shadow: var(--card-shadow);
  text-align:center;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.stat-card .value { font-size:2rem;font-weight:700;color:var(--text);margin:.2rem 0 }
.stat-card .desc { font-weight:600; color:var(--accent); font-size:.98rem; margin-bottom:.2em; }
.stat-card .subdesc { font-size:.89rem;color:var(--text-muted);font-weight:400 }
.stat-card i { font-size:2rem; margin-bottom:.35em; color:var(--accent) }

/* Dark theme card enhancements */
[data-theme="dark"] .stat-card {
  border: 1px solid rgba(64, 64, 64, 0.4);
  box-shadow: 
    0 8px 32px rgba(0, 0, 0, 0.8),
    0 0 20px rgba(240, 185, 11, 0.1),
    inset 0 1px 0 rgba(128, 128, 128, 0.1);
}

[data-theme="dark"] .stat-card:hover {
  transform: translateY(-5px);
  box-shadow: 
    0 12px 40px rgba(0, 0, 0, 0.9),
    0 0 30px rgba(240, 185, 11, 0.2),
    0 0 10px rgba(255, 215, 0, 0.15),
    inset 0 1px 0 rgba(240, 185, 11, 0.2);
  border-color: rgba(240, 185, 11, 0.3);
}

[data-theme="dark"] .stat-card i {
  color: var(--accent-light);
  text-shadow: 0 0 15px rgba(240, 185, 11, 0.6);
  animation: iconPulse 3s ease-in-out infinite;
}

@keyframes iconPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

/* Task widget */
.task-widget {
  background: var(--card-bg);
  border-radius:12px;
  padding:1rem;
  box-shadow: var(--card-shadow);
  max-width:270px;
  color:var(--text);
  align-self:stretch;
  display:flex; flex-direction:column;
  justify-content:space-between;
}
.task-widget h3 { color:var(--accent);font-size:1.05rem;font-weight:700;margin-bottom:.8rem }
.task-list { list-style:none;margin:0 0 .9rem 0;padding:0 }
.task-list li {
  background: var(--glass-glow);
  border-radius:7px;
  padding:.5rem .7rem;
  color: var(--text);
  font-size:.91rem;
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:.55rem;
  border: 1px solid var(--border);
}
.badge { font-size:.7rem;font-weight:700;border-radius:12px;padding:.12rem .55rem }
.badge.due { background:var(--badge-due);color:#000 }
.badge.new { background:var(--badge-new);color:#fff }
.check { color:var(--task-done);font-size:1rem }
.task-widget button {
  width: 100%;
  background: linear-gradient(90deg, #ffe267 0%, #ffbb1e 100%);
  color: #111;
  font-weight: 800;
  border: none;
  border-radius: 7px;
  font-size: 1.07rem;
  padding: 0.58rem 0;
  transition: background .22s;
  box-shadow: 0 2px 12px 0 #ffe26780;
  margin-top:.7em;
}
.task-widget button:hover { background: var(--accent); color: #222; }

/* Progress bars and widgets */
.progress-widgets {
  display: flex; gap:2.4rem; margin-top:1.5rem; margin-bottom:0;
}
.progress-bars-col {
  display: flex;
  flex-direction: column;
  gap: 1.25em;
  flex: 1 1 250px;
  min-width: 210px;
}
.progress-bar-widget {
  display: flex;
  flex-direction: column;
  gap: .25em;
  background: var(--glass);
  border-radius: 10px;
  box-shadow: 0 1px 3px 0 var(--border);
  margin-bottom: 0.25em;
  padding: .7em 1.1em .95em 1.1em;
}
.progress-bar-label {
  display: flex; align-items: center; justify-content: space-between; margin-bottom: .35em; color: var(--accent); font-size: .99em; font-weight: 700;
}
.progress-bar-label i { margin-right: 7px; font-size: 1.1em; }
.custom-progress {
  height: 9px;
  width: 100%;
  background: var(--rail);
  border-radius: 6px;
  box-shadow: 0 1px 2px 0 var(--border);
  overflow: hidden;
}
.custom-progress-bar {
  height: 100%;
  width: 0;
  background: linear-gradient(90deg,var(--accent) 60%,#fffbe2 100%);
  border-radius: 6px;
  transition: width 1s cubic-bezier(.56,.08,.28,1.15);
}
[data-theme="light"] .custom-progress-bar {
  background: linear-gradient(90deg,#ffe267 60%,#fffde2 100%);
}
/* Activity feed alignment - Landscape Layout */
.activity-feed {
  background: var(--glass);
  border-radius:12px;
  border:1px solid var(--border);
  padding:1.2em 1.5em .7em 1.5em;
  box-shadow:0 2px 14px 0 #b59e0022;
  flex: 1 1 100%;
  min-width: 100%;
  width: 100%;
}
.activity-feed h4 { color: var(--accent); font-size: 1.03em; font-weight: 700; margin-bottom: 1em; }
.activity-feed ul { 
  list-style:none;
  margin:0;
  padding:0;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1rem;
}
.activity-feed li { 
  display:flex;
  align-items:center;
  gap:.8em; 
  padding: .8em 1em; 
  background: rgba(240, 185, 11, 0.05);
  border: 1px solid rgba(240, 185, 11, 0.15);
  border-radius: 8px;
  font-size: .95em;
  transition: all 0.3s ease;
}
.activity-feed li:hover {
  background: rgba(240, 185, 11, 0.1);
  border-color: rgba(240, 185, 11, 0.25);
  transform: translateY(-2px);
}
.activity-feed i { color: var(--accent); font-size:1.2em; }

/* Dark theme activity feed text fixes */
[data-theme="dark"] .activity-feed li {
  color: var(--text);
}

[data-theme="dark"] .activity-feed .user-name {
  color: var(--text);
}

[data-theme="dark"] .activity-feed .notif-time {
  color: var(--text-muted);
}

[data-theme="dark"] .activity-feed li {
  background: rgba(240, 185, 11, 0.08);
  border-color: rgba(240, 185, 11, 0.2);
}

[data-theme="dark"] .activity-feed li:hover {
  background: rgba(240, 185, 11, 0.15);
  border-color: rgba(240, 185, 11, 0.3);
}

/* User/notification styles */
.user-pill-dropdown {
  background: var(--accent);
  border: none;
  border-radius: 28px;
  color: #222;
  font-weight: 700;
  padding: .3rem 1.2rem .3rem .7rem;
  display: flex;
  align-items: center;
  gap: .6rem;
  font-size: 1.08rem;
  box-shadow: 0 1px 7px 0 var(--border);
  cursor: pointer;
  position: relative;
}
.user-pill-dropdown .avatar-img {
  width:32px; height:32px;
  border-radius:50%;
  object-fit:cover;
  margin-right:.2em;
  border:2px solid var(--accent);
}
.user-pill-dropdown .dropdown-caret {
  font-size:1.25em; margin-left:.4em;
}
.user-menu-dropdown {
  position: absolute;
  top: 110%; right: 0;
  min-width: 180px;
  background: var(--glass);
  border: 1px solid var(--border);
  border-radius: 12px;
  color: var(--accent);
  box-shadow: 0 3px 14px 0 #b59e0022;
  display: none;
  z-index: 30;
}
.user-menu-dropdown.show { display: block }
.user-menu-dropdown a, .user-menu-dropdown button {
  display: block;
  width: 100%;
  padding: 10px 16px;
  color: var(--accent);
  background: transparent;
  border: none;
  text-align: left;
  font-weight: 600;
  cursor: pointer;
}
.user-menu-dropdown a:hover, .user-menu-dropdown button:hover {
  background: var(--accent); color: #000;
}

/* Notification bell & dropdown */
.notification-btn {
  background:transparent;
  border:none;
  color:var(--accent);
  position:relative;
  font-size:1.6rem;
  margin-left:.2em;
  margin-right:.6em;
  cursor:pointer;
}
.notification-btn .badge {
  position:absolute;top:-8px;right:-5px;
  font-size:.75rem;
  background:#dc3545;
  color:#fff;
  padding:1.5px 6px;
  border-radius:12px;
  font-weight:700;
}
.notif-dropdown {
  position: absolute;
  top: 120%; right: 0;
  min-width: 260px;
  background: var(--glass);
  border: 1px solid var(--border);
  border-radius: 12px;
  color: var(--accent);
  box-shadow: 0 3px 16px 0 #b59e0022;
  display: none;
  z-index: 30;
  padding: 0;
}
.notif-dropdown.show { display:block }
.notif-dropdown ul { list-style:none; margin:0; padding:0 }
.notif-dropdown li {
  padding: 11px 18px 11px 18px;
  border-bottom: 1px solid #ffe28b44;
  display: flex; align-items: center; gap:.85rem;
  color: #fffde1;
  font-size: .97em;
}
[data-theme="light"] .notif-dropdown li {
  color: #222;
}
.notif-dropdown .notif-time {
  font-size: .87em;
  color: #c2a900;
  margin-left: auto;
}

/* Dark/Light toggle */
.darkmode-btn {
  border: none;
  background: transparent;
  color: var(--accent);
  font-size: 1.45em;
  margin-left: 1.3em;
  cursor: pointer;
  outline: none;
}
.darkmode-btn:focus { outline: 2px solid var(--accent) }
/* Responsive tweaks */
@media(max-width:1200px) and (min-width:769px){
  nav.sidebar{width:90px}nav.sidebar.collapsed{width:70px}
  .main{margin-left:90px}.sidebar.collapsed~.main{margin-left:70px}
  .sidebar-link span,.sidebar-dropdown span{display:none}
}
@media(max-width:980px){
  .progress-widgets { flex-direction: column; gap:1.1rem; }
  .activity-feed { 
    max-width:100%; 
  }
  .activity-feed ul {
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 0.8rem;
  }
}

@media(max-width:600px){
  .activity-feed ul {
    grid-template-columns: 1fr;
    gap: 0.6rem;
  }
  .activity-feed li {
    padding: 0.6em 0.8em;
    font-size: 0.9em;
  }
}
@media(max-width:768px){
  nav.sidebar {
    transform: translateX(-100%);
    transition: transform 0.3s ease;
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1000;
  }
  nav.sidebar.open {
    transform: translateX(0);
  }
  .main {
    margin-left: 0 !important;
    padding: 0.8rem !important;
  }
  .charts-wrapper{flex-direction:column}
  .task-widget{max-width:100%}
  header{flex-direction:column;gap:.7rem}
  .mini-stats-bar { flex-direction:column; gap:.8em; padding:.9em 1.1em }
  .main { padding: 0.55em; }

  /* Neaten mobile layout */
  /* Quick actions as two columns */
  .quick-actions {
    display: grid !important;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
  }
  .quick-actions button {
    width: 100%;
    margin: 0 !important;
  }
  /* Mini stats bar wrap */
  .mini-stats-bar {
    flex-wrap: wrap;
    gap: 0.5rem;
    padding: 0.5rem 0.8rem;
  }
  .mini-stats-bar .stat {
    flex: 1 1 45%;
    justify-content: center;
  }
  /* Center header elements */
  header {
    text-align: center;
  }
  header .left, header .right {
    width: 100%;
    justify-content: center;
  }
}
    @media (max-width: 768px) {
      .logo img {
        max-width: 100px;
        margin-top: 1.2rem;
        margin-bottom: 1.2rem;
      }
    }
    .logo {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .logo-fire {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: 2;
      width: 170px; height: 112px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    @media (max-width: 768px) {
      .logo-fire {
        width: 88px; height: 55px;
      }
    }
    .logo-fire-rocket {
      width: 105%; height: 112px;
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: 2;
      overflow: visible;
    }
    @media (max-width: 768px) {
      .logo-fire-rocket { width: 58px; height: 55px; }
    }
    /* Vanta.NET background container */
    .main {
      position: relative;
      overflow: hidden;
    }
    .main canvas {
      position: absolute !important;
      top: 0;
      left: 0;
      width: 100% !important;
      height: 100% !important;
      z-index: -1 !important;
    }
  </style>
</head>
<body>
<!-- Universal Sidebar Container -->
<div id="sidebar-container"></div>


<!--  MAIN  -->
<main class="main-content">
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <h1><i class="bi bi-speedometer2"></i> <span id="dashboardTitle">Admin Dashboard</span></h1>
      <div class="datetime-info">
        <div id="currentDate" class="current-date"></div>
        <div id="currentTime" class="current-time"></div>
      </div>
    </div>
    <div class="header-right">
      <button class="btn btn-outline-warning btn-sm" onclick="toggleTheme()" title="Toggle light/dark theme">
        <i id="themeIcon" class="bi bi-moon-fill"></i>
      </button>
      <div class="notifications-container">
        <button class="notification-btn" onclick="toggleNotifications()">
          <i class="bi bi-bell"></i>
          <span class="notification-badge" id="notifBadge" style="display: none;">0</span>
        </button>
        <div class="notifications-dropdown" id="notifDropdown">
          <div class="notifications-header">
            <h4>Notifications</h4>
            <button class="mark-all-read" onclick="markAllRead()">Mark all read</button>
          </div>
          <div class="notifications-list" id="notificationsList">
            <div class="notification-item">
              <div class="notification-icon payment">
                <i class="bi bi-credit-card"></i>
              </div>
              <div class="notification-content">
                <div class="notification-title">Payment Received</div>
                <div class="notification-message">Loading notifications...</div>
                <div class="notification-time">now</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="user-menu">
        <button class="user-btn" onclick="toggleUserMenu()">
          <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="Admin" class="user-avatar" />
          <span class="user-name">Admin</span>
          <i class="bi bi-chevron-down"></i>
        </button>
        <div class="user-dropdown" id="userDropdown">
          <a href="profile.html"><i class="bi bi-person-circle"></i> Profile</a>
          <a href="settings.html"><i class="bi bi-gear"></i> Settings</a>
          <div class="dropdown-divider"></div>
          <button onclick="logout()"><i class="bi bi-box-arrow-right"></i> Logout</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced Stats Grid with Trends -->
  <div class="stats-grid">
    <div class="stat-card" data-trend="up">
      <div class="stat-header">
        <div class="stat-info">
          <div class="stat-number" id="totalCustomers">218</div>
          <div class="stat-trend">
            <i class="bi bi-arrow-up"></i>
            <span>+12.5%</span>
          </div>
        </div>
        <i class="bi bi-people stat-icon"></i>
      </div>
      <div class="stat-label">Total Customers</div>
      <div class="stat-progress">
        <div class="progress-fill" style="width: 85%"></div>
      </div>
    </div>

    <div class="stat-card" data-trend="up">
      <div class="stat-header">
        <div class="stat-info">
          <div class="stat-number" id="totalOrders">138</div>
          <div class="stat-trend">
            <i class="bi bi-arrow-up"></i>
            <span>+18.7%</span>
          </div>
        </div>
        <i class="bi bi-bag stat-icon"></i>
      </div>
      <div class="stat-label">Total Orders</div>
      <div class="stat-progress">
        <div class="progress-fill" style="width: 72%"></div>
      </div>
    </div>

    <div class="stat-card" data-trend="up">
      <div class="stat-header">
        <div class="stat-info">
          <div class="stat-number" id="todayRevenue">$2,410</div>
          <div class="stat-trend">
            <i class="bi bi-arrow-up"></i>
            <span>+8.2%</span>
          </div>
        </div>
        <i class="bi bi-cash-stack stat-icon"></i>
      </div>
      <div class="stat-label">Today's Revenue</div>
      <div class="stat-progress">
        <div class="progress-fill" style="width: 92%"></div>
      </div>
    </div>

    <div class="stat-card" data-trend="up">
      <div class="stat-header">
        <div class="stat-info">
          <div class="stat-number" id="monthlyRevenue">$6,500</div>
          <div class="stat-trend">
            <i class="bi bi-arrow-up"></i>
            <span>+15.3%</span>
          </div>
        </div>
        <i class="bi bi-bar-chart-line stat-icon"></i>
      </div>
      <div class="stat-label">Monthly Revenue</div>
      <div class="stat-progress">
        <div class="progress-fill" style="width: 78%"></div>
      </div>
    </div>
  </div>

  <!-- User Management Section (Permission-Based Visibility) -->
  <div class="admin-management-card" id="userManagementSection" style="display: none;">
    <h3><i class="bi bi-people-fill"></i> User Management</h3>
    
    <!-- Filter Section -->
    <div class="filter-section">
      <select id="roleFilter">
        <option value="">All Roles</option>
        <option value="main-admin">Main Admin</option>
        <option value="admin">Admin</option>
        <option value="support">Support</option>
      </select>
      <select id="statusFilter">
        <option value="">All Status</option>
        <option value="active">Active</option>
        <option value="inactive">Inactive</option>
      </select>
      <input type="search" id="searchAdmins" placeholder="Search admins...">
      <button class="action-btn" id="addUserBtn" onclick="addNewUser()" style="display: none;">
        <i class="bi bi-plus-circle"></i> Add User
      </button>
      <button class="action-btn" id="addAdminBtn" onclick="addNewAdmin()" style="display: none;">
        <i class="bi bi-shield-plus"></i> Add Admin
      </button>
    </div>

    <div class="admin-table">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>User</th>
            <th>Email</th>
            <th>Role</th>
            <th>Permissions</th>
            <th>Status</th>
            <th>Last Login</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="usersTableBody">
          <tr>
            <td>
              <div class="d-flex align-items-center">
                <div class="admin-avatar">MF</div>
                <strong>Main Founder</strong>
              </div>
            </td>
            <td>founder@vbms.com</td>
            <td><span class="badge badge-main-admin">Main Admin</span></td>
            <td><span class="badge badge-full">Full Access</span></td>
            <td><span class="badge badge-active">Active</span></td>
            <td>2 minutes ago</td>
            <td>
              <a href="#" class="action-btn"><i class="bi bi-eye"></i> View</a>
              <span class="text-muted small">Self</span>
            </td>
          </tr>
          <tr>
            <td>
              <div class="d-flex align-items-center">
                <div class="admin-avatar">SA</div>
                <strong>System Admin</strong>
              </div>
            </td>
            <td>admin@vbms.com</td>
            <td><span class="badge badge-admin">Admin</span></td>
            <td><span class="badge badge-full">Full Access</span></td>
            <td><span class="badge badge-active">Active</span></td>
            <td>15 minutes ago</td>
            <td>
              <a href="#" class="action-btn"><i class="bi bi-eye"></i> View</a>
              <a href="#" class="action-btn"><i class="bi bi-pencil"></i> Edit</a>
              <a href="#" class="action-btn btn-danger"><i class="bi bi-x-circle"></i> Disable</a>
            </td>
          </tr>
          <tr>
            <td>
              <div class="d-flex align-items-center">
                <div class="admin-avatar">CM</div>
                <strong>Customer Manager</strong>
              </div>
            </td>
            <td>customer.admin@vbms.com</td>
            <td><span class="badge badge-admin">Admin</span></td>
            <td><span class="badge badge-limited">Limited</span></td>
            <td><span class="badge badge-active">Active</span></td>
            <td>1 hour ago</td>
            <td>
              <a href="#" class="action-btn"><i class="bi bi-eye"></i> View</a>
              <a href="#" class="action-btn"><i class="bi bi-pencil"></i> Edit</a>
              <a href="#" class="action-btn btn-danger"><i class="bi bi-x-circle"></i> Disable</a>
            </td>
          </tr>
          <tr>
            <td>
              <div class="d-flex align-items-center">
                <div class="admin-avatar">SS</div>
                <strong>Support Specialist</strong>
              </div>
            </td>
            <td>support@vbms.com</td>
            <td><span class="badge badge-support">Support</span></td>
            <td><span class="badge badge-readonly">Read Only</span></td>
            <td><span class="badge badge-active">Active</span></td>
            <td>3 hours ago</td>
            <td>
              <a href="#" class="action-btn"><i class="bi bi-eye"></i> View</a>
              <a href="#" class="action-btn"><i class="bi bi-pencil"></i> Edit</a>
              <a href="#" class="action-btn btn-danger"><i class="bi bi-x-circle"></i> Disable</a>
            </td>
          </tr>
          <tr>
            <td>
              <div class="d-flex align-items-center">
                <div class="admin-avatar">BA</div>
                <strong>Billing Admin</strong>
              </div>
            </td>
            <td>billing@vbms.com</td>
            <td><span class="badge badge-admin">Admin</span></td>
            <td><span class="badge badge-limited">Limited</span></td>
            <td><span class="badge badge-active">Active</span></td>
            <td>5 hours ago</td>
            <td>
              <a href="#" class="action-btn"><i class="bi bi-eye"></i> View</a>
              <a href="#" class="action-btn"><i class="bi bi-pencil"></i> Edit</a>
              <a href="#" class="action-btn btn-danger"><i class="bi bi-x-circle"></i> Disable</a>
            </td>
          </tr>
          <tr>
            <td>
              <div class="d-flex align-items-center">
                <div class="admin-avatar">TA</div>
                <strong>Technical Admin</strong>
              </div>
            </td>
            <td>tech@vbms.com</td>
            <td><span class="badge badge-admin">Admin</span></td>
            <td><span class="badge badge-full">Full Access</span></td>
            <td><span class="badge badge-active">Active</span></td>
            <td>1 day ago</td>
            <td>
              <a href="#" class="action-btn"><i class="bi bi-eye"></i> View</a>
              <a href="#" class="action-btn"><i class="bi bi-pencil"></i> Edit</a>
              <a href="#" class="action-btn btn-danger"><i class="bi bi-x-circle"></i> Disable</a>
            </td>
          </tr>
          <tr>
            <td>
              <div class="d-flex align-items-center">
                <div class="admin-avatar">RA</div>
                <strong>Reports Admin</strong>
              </div>
            </td>
            <td>reports@vbms.com</td>
            <td><span class="badge badge-admin">Admin</span></td>
            <td><span class="badge badge-readonly">Read Only</span></td>
            <td><span class="badge badge-inactive">Inactive</span></td>
            <td>3 days ago</td>
            <td>
              <a href="#" class="action-btn"><i class="bi bi-eye"></i> View</a>
              <a href="#" class="action-btn"><i class="bi bi-pencil"></i> Edit</a>
              <a href="#" class="action-btn text-success"><i class="bi bi-check-circle"></i> Enable</a>
            </td>
          </tr>
          <tr>
            <td>
              <div class="d-flex align-items-center">
                <div class="admin-avatar">MA</div>
                <strong>Marketing Admin</strong>
              </div>
            </td>
            <td>marketing@vbms.com</td>
            <td><span class="badge badge-admin">Admin</span></td>
            <td><span class="badge badge-limited">Limited</span></td>
            <td><span class="badge badge-active">Active</span></td>
            <td>2 days ago</td>
            <td>
              <a href="#" class="action-btn"><i class="bi bi-eye"></i> View</a>
              <a href="#" class="action-btn"><i class="bi bi-pencil"></i> Edit</a>
              <a href="#" class="action-btn btn-danger"><i class="bi bi-x-circle"></i> Disable</a>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Enhanced Stats for Main Admin -->
  <div class="stats-grid" id="mainAdminStats" style="display: none;">
    <div class="stat-card" data-trend="up">
      <div class="stat-header">
        <div class="stat-info">
          <div class="stat-number" id="totalAdmins">8</div>
          <div class="stat-trend">
            <i class="bi bi-arrow-up"></i>
            <span>+2 new</span>
          </div>
        </div>
        <i class="bi bi-people-fill stat-icon"></i>
      </div>
      <div class="stat-label">Total Admins</div>
      <div class="stat-progress">
        <div class="progress-fill" style="width: 80%"></div>
      </div>
    </div>

    <div class="stat-card" data-trend="stable">
      <div class="stat-header">
        <div class="stat-info">
          <div class="stat-number" id="systemUptime">99.9%</div>
          <div class="stat-trend">
            <i class="bi bi-dash"></i>
            <span>Stable</span>
          </div>
        </div>
        <i class="bi bi-shield-check stat-icon"></i>
      </div>
      <div class="stat-label">System Uptime</div>
      <div class="stat-progress">
        <div class="progress-fill" style="width: 99%"></div>
      </div>
    </div>
  </div>

  <!-- order / revenue -->
  <section class="card-section">
    <h2>Order & Revenue Overview</h2>
    <div class="stats-grid">
      <div class="stat-card">
        <i class="bi bi-box"></i>
        <div class="desc">Orders Today</div>
        <div class="value"><span id="ordersToday" data-target="138">0</span></div>
        <div class="subdesc">All sources</div>
      </div>
      <div class="stat-card">
        <i class="bi bi-currency-dollar"></i>
        <div class="desc">Revenue Today</div>
        <div class="value">$<span id="revenueToday" data-target="2410">0</span></div>
        <div class="subdesc">All customers</div>
      </div>
      <div class="stat-card">
        <i class="bi bi-graph-up-arrow"></i>
        <div class="desc">Revenue This Month</div>
        <div class="value">$<span id="revenueMonth" data-target="6500">0</span></div>
        <div class="subdesc">Total</div>
      </div>
    </div>
  </section>

  <!-- biz insights -->
  <section class="card-section">
    <h2>Business Insights</h2>
    <div class="stats-grid">
      <div class="stat-card">
        <i class="bi bi-person-plus"></i>
        <div class="desc">New Customers Today</div>
        <div class="value">5</div>
      </div>
      <div class="stat-card">
        <i class="bi bi-people"></i>
        <div class="desc">Total Customers</div>
        <div class="value">218</div>
      </div>
      <div class="stat-card">
        <i class="bi bi-credit-card"></i>
        <div class="desc">Successful Payments</div>
        <div class="value">25,296</div>
      </div>
      <div class="stat-card">
        <i class="bi bi-bank"></i>
        <div class="desc">Pending Payouts</div>
        <div class="value">$102,633</div>
      </div>
      <!-- task widget -->
      <div class="task-widget">
        <h3>Today's Tasks</h3>
        <ul class="task-list">
          <li>Follow-up Client B <span class="badge due">Due</span></li>
          <li>Send invoice #452 <i class="bi bi-check2-circle check"></i></li>
          <li>Assign new lead <span class="badge new">New</span></li>
        </ul>
        <button onclick="location='task-board.html'">Go to Task Board</button>
      </div>
    </div>
    <!-- Progress bars and activity feed -->
    <div class="progress-widgets">
      <div class="progress-bars-col">
        <div class="progress-bar-widget">
          <div class="progress-bar-label">
            <span><i class="bi bi-check-circle"></i>Tasks Completed Today</span>
            <span id="tasksPercentLabel">70%</span>
          </div>
          <div class="custom-progress">
            <div class="custom-progress-bar" id="tasksBar"></div>
          </div>
        </div>
        <div class="progress-bar-widget">
          <div class="progress-bar-label">
            <span><i class="bi bi-flag"></i>Goal Reached</span>
            <span id="goalPercentLabel">50%</span>
          </div>
          <div class="custom-progress">
            <div class="custom-progress-bar" id="goalBar"></div>
          </div>
        </div>
      </div>
      <div class="activity-feed">
        <h4><i class="bi bi-clock-history"></i> Recent Activity</h4>
        <ul>
          <li><i class="bi bi-door-open"></i> <span class="user-name">Admin</span> logged in <span class="notif-time">now</span></li>
          <li><i class="bi bi-cash-coin"></i> Payment received <span class="notif-time">2 min ago</span></li>
          <li><i class="bi bi-pencil"></i> Profile updated <span class="notif-time">12 min ago</span></li>
          <li><i class="bi bi-envelope"></i> New message sent <span class="notif-time">18 min ago</span></li>
        </ul>
      </div>
    </div>
  </section>
</main>

<!-- User Management Modal with Granular Permissions -->
<div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content" style="background: var(--card-bg); border: 1px solid var(--border);">
      <div class="modal-header" style="background: var(--accent); color: #000;">
        <h5 class="modal-title" id="userModalLabel">
          <i class="bi bi-person-plus-fill"></i> Create/Edit User
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="userForm">
          <!-- Basic User Information -->
          <div class="row mb-4">
            <div class="col-md-6">
              <h6 style="color: var(--accent); margin-bottom: 15px;">
                <i class="bi bi-person-circle"></i> Basic Information
              </h6>
              <div class="mb-3">
                <label for="userName" class="form-label">Full Name</label>
                <input type="text" class="form-control" id="userName" required 
                       style="background: var(--glass); border: 1px solid var(--border); color: var(--text);">
              </div>
              <div class="mb-3">
                <label for="userEmail" class="form-label">Email Address</label>
                <input type="email" class="form-control" id="userEmail" required
                       style="background: var(--glass); border: 1px solid var(--border); color: var(--text);">
              </div>
              <div class="mb-3">
                <label for="userRole" class="form-label">Primary Role</label>
                <select class="form-select" id="userRole" required
                        style="background: var(--glass); border: 1px solid var(--border); color: var(--text);">
                  <option value="">Select Role</option>
                  <option value="main_admin">Main Admin</option>
                  <option value="admin">Admin</option>
                  <option value="support">Support</option>
                  <option value="customer">Customer</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="userStatus" class="form-label">Status</label>
                <select class="form-select" id="userStatus"
                        style="background: var(--glass); border: 1px solid var(--border); color: var(--text);">
                  <option value="active">Active</option>
                  <option value="inactive">Inactive</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <h6 style="color: var(--accent); margin-bottom: 15px;">
                <i class="bi bi-shield-lock"></i> Security Settings
              </h6>
              <div class="mb-3">
                <label for="userPassword" class="form-label">Password</label>
                <input type="password" class="form-control" id="userPassword"
                       style="background: var(--glass); border: 1px solid var(--border); color: var(--text);">
                <div class="form-text">Leave blank to keep existing password</div>
              </div>
              <div class="mb-3">
                <label for="confirmPassword" class="form-label">Confirm Password</label>
                <input type="password" class="form-control" id="confirmPassword"
                       style="background: var(--glass); border: 1px solid var(--border); color: var(--text);">
              </div>
              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="requirePasswordChange">
                <label class="form-check-label" for="requirePasswordChange">
                  Require password change on next login
                </label>
              </div>
            </div>
          </div>

          <!-- Granular Permissions Grid -->
          <div class="permissions-section">
            <h6 style="color: var(--accent); margin-bottom: 15px;">
              <i class="bi bi-shield-check"></i> Granular Permissions
            </h6>
            <div class="alert alert-info" style="background: rgba(59, 130, 246, 0.1); border-color: var(--info); color: var(--text);">
              <i class="bi bi-info-circle"></i> 
              Select specific permissions for this user. Default permissions are applied based on role, but you can customize them here.
            </div>
            
            <div id="permissionsGrid" class="permissions-grid">
              <!-- Permissions will be dynamically loaded here -->
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer" style="background: var(--glass); border-top: 1px solid var(--border);">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i> Cancel
        </button>
        <button type="button" class="btn" id="saveUserBtn" onclick="saveUser()"
                style="background: var(--accent); color: #000; font-weight: 700;">
          <i class="bi bi-check-circle"></i> Save User
        </button>
      </div>
    </div>
  </div>
</div>

<style>
/* Permissions Grid Styling */
.permissions-grid {
  background: var(--glass);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
}

.permission-category {
  margin-bottom: 25px;
  border: 1px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
}

.permission-category-header {
  background: var(--accent);
  color: #000;
  padding: 12px 15px;
  font-weight: 700;
  font-size: 1rem;
  display: flex;
  align-items: center;
  gap: 8px;
}

.permission-category-body {
  padding: 15px;
  background: var(--card-bg);
}

.permission-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 0;
  border-bottom: 1px solid var(--border);
}

.permission-row:last-child {
  border-bottom: none;
}

.permission-info {
  flex: 1;
}

.permission-label {
  font-weight: 600;
  color: var(--text);
  margin-bottom: 2px;
}

.permission-description {
  font-size: 0.85rem;
  color: var(--text-muted);
}

.permission-toggle {
  display: flex;
  align-items: center;
  gap: 8px;
}

.permission-checkbox {
  width: 18px;
  height: 18px;
  cursor: pointer;
}

.select-all-category {
  background: rgba(240, 185, 11, 0.1);
  border: 1px solid rgba(240, 185, 11, 0.3);
  border-radius: 6px;
  padding: 8px 12px;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  color: var(--accent);
}

.select-all-checkbox {
  width: 16px;
  height: 16px;
}

/* Dark theme modal enhancements */
[data-theme="dark"] .modal-content {
  border: 1px solid rgba(64, 64, 64, 0.4);
  box-shadow: 
    0 8px 32px rgba(0, 0, 0, 0.8),
    0 0 20px rgba(240, 185, 11, 0.1);
}

[data-theme="dark"] .permission-category {
  border-color: rgba(64, 64, 64, 0.4);
}

[data-theme="dark"] .permission-row {
  border-color: rgba(64, 64, 64, 0.2);
}
</style>

<!-- scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="auth.js"></script>
<script src="load-sidebar.js"></script>
<script src="theme-manager.js"></script>
<script src="notifications-manager.js"></script>
<script src="activity-tracker.js"></script>
<script src="api-simulation.js"></script>
<script>
// Authentication check - require admin role with enhanced race condition protection
let authCheckInProgress = false;
let lastAuthCheck = 0;
function checkAuthWithRetry(maxRetries = 5, delay = 150) {
  // Prevent multiple auth checks from running simultaneously
  const now = Date.now();
  if (authCheckInProgress || (now - lastAuthCheck < 500)) {
    console.log('Auth check already in progress or too recent, skipping...');
    return;
  }
  authCheckInProgress = true;
  lastAuthCheck = now;
  
  let retries = 0;
  
  function attemptAuth() {
    console.log(`Auth attempt ${retries + 1}/${maxRetries}`);
    
    if (!vbmsAuth.isAuthenticated()) {
      console.log('User not authenticated - redirecting to login');
      authCheckInProgress = false;
      window.location.href = 'login.html';
      return;
    }

    const userRole = vbmsAuth.getCurrentRole();
    console.log(`Current user role: "${userRole}"`);
    
    // If role is empty/undefined and we haven't exhausted retries, wait and try again
    if ((!userRole || userRole === '' || userRole === 'null' || userRole === 'undefined') && retries < maxRetries) {
      retries++;
      console.log(`Role not loaded yet, retrying in ${delay}ms...`);
      setTimeout(attemptAuth, delay);
      return;
    }
    
    // If still no role after retries, redirect to login  
    if (!userRole || userRole === '' || userRole === 'null' || userRole === 'undefined') {
      console.log('Auth check failed - no valid role found after retries');
      authCheckInProgress = false;
      alert('Session expired. Please log in again.');
      window.location.href = 'login.html';
      return;
    }
    
    // Double-check admin status with explicit role checking
    const isUserAdmin = (userRole === 'admin' || userRole === 'main_admin');
    console.log(`User role: ${userRole}, isAdmin: ${isUserAdmin}`);
    
    if (!isUserAdmin) {
      console.log(`Access denied for role: ${userRole}`); 
      authCheckInProgress = false;
      alert('Access Denied: Admin access required for dashboard');
      
      // Redirect based on role with safety checks
      if (userRole === 'customer' || userRole === 'client') {
        console.log('Redirecting to customer dashboard');
        window.location.href = 'customer-dashboard.html';
      } else {
        console.log('Redirecting to login');
        window.location.href = 'login.html';
      }
      return;
    }
    
    console.log('Authentication successful - initializing dashboard');
    authCheckInProgress = false;
    // Auth successful - continue with page initialization
    initializeDashboard();
  }
  
  attemptAuth();
}

function initializeDashboard() {
  // Display user info
  const user = vbmsAuth.getCurrentUser();
  if (user) {
    // Update user name
    const userNameElements = document.querySelectorAll('.user-name');
    userNameElements.forEach(el => {
      el.textContent = user.name || 'Admin User';
    });
    
    // Update user role
    const userRoleElements = document.querySelectorAll('.user-role');
    const role = vbmsAuth.getCurrentRole();
    const roleDisplayName = role === 'main_admin' ? 'Main Admin' : 
                           role === 'admin' ? 'Admin' : 
                           role === 'support' ? 'Support' :
                           role === 'customer' ? 'Customer' : 
                           role === 'client' ? 'Customer' : 'Manager';
    
    userRoleElements.forEach(el => {
      el.textContent = roleDisplayName;
    });

    // Initialize standard admin UI
    initializeAdminUI();

    // Track dashboard access
    if (window.vbmsNotifications) {
      vbmsNotifications.createActivity('dashboard_access', {
        title: `${roleDisplayName} accessed dashboard`,
        user: user.name,
        userRole: role,
        priority: vbmsNotifications.PRIORITY.LOW,
        module: 'Dashboard'
      });
    }
  }
}

// Permission-based UI initialization
function initializePermissionBasedUI() {
  console.log('🎨 Initializing permission-based UI...');
  
  // Apply permissions using the permissions manager
  if (window.vbmsPermissions) {
    vbmsPermissions.applyUIPermissions();
    
    // Initialize filters if user management section is visible
    if (vbmsPermissions.hasPermission('users_view') || vbmsPermissions.hasPermission('admin_manage')) {
      initializeUserFilters();
      loadUserManagementData();
    }
    
    // Load appropriate stats based on permissions
    if (vbmsPermissions.hasPermission('admin_manage')) {
      loadMainAdminStats();
    }
    
    console.log('✅ Permission-based UI initialized');
  } else {
    console.log('⚠️ Permissions manager not available, falling back to role-based UI');
    initializeFallbackUI();
  }
}

function initializeFallbackUI() {
  // Fallback for when permissions manager is not available
  const role = vbmsAuth.getCurrentRole();
  
  if (role === 'main_admin') {
    document.getElementById('userManagementSection').style.display = 'block';
    document.getElementById('mainAdminStats').style.display = 'grid';
    document.getElementById('addUserBtn').style.display = 'inline-block';
    document.getElementById('addAdminBtn').style.display = 'inline-block';
    initializeUserFilters();
    loadMainAdminStats();
  } else if (role === 'admin') {
    document.getElementById('userManagementSection').style.display = 'block';
    document.getElementById('addUserBtn').style.display = 'inline-block';
    initializeUserFilters();
  }
}

// User management functions (renamed from admin management)
function initializeUserFilters() {
  const roleFilter = document.getElementById('roleFilter');
  const statusFilter = document.getElementById('statusFilter');
  const searchInput = document.getElementById('searchAdmins');
  
  if (roleFilter) {
    roleFilter.addEventListener('change', filterUsers);
  }
  if (statusFilter) {
    statusFilter.addEventListener('change', filterUsers);
  }
  if (searchInput) {
    searchInput.addEventListener('input', filterUsers);
  }
}

function filterUsers() {
  const roleFilter = document.getElementById('roleFilter').value;
  const statusFilter = document.getElementById('statusFilter').value;
  const searchTerm = document.getElementById('searchAdmins').value.toLowerCase();
  const tableBody = document.getElementById('usersTableBody');
  const rows = tableBody.getElementsByTagName('tr');

  for (let row of rows) {
    const cells = row.getElementsByTagName('td');
    if (cells.length === 0) continue;

    const userName = cells[0].textContent.toLowerCase();
    const email = cells[1].textContent.toLowerCase();
    const role = cells[2].textContent.toLowerCase();
    const status = cells[4].textContent.toLowerCase();

    let showRow = true;

    // Role filter
    if (roleFilter && !role.includes(roleFilter.replace('-', ' '))) {
      showRow = false;
    }

    // Status filter
    if (statusFilter && !status.includes(statusFilter)) {
      showRow = false;
    }

    // Search filter
    if (searchTerm && !userName.includes(searchTerm) && !email.includes(searchTerm)) {
      showRow = false;
    }

    row.style.display = showRow ? '' : 'none';
  }
}

function loadUserManagementData() {
  // Simulate loading user data - in real app this would come from API
  console.log('📊 Loading user management data...');
  
  // Update the table with sample data that shows the unified approach
  const tableBody = document.getElementById('usersTableBody');
  if (tableBody) {
    // Keep existing admin data but make it more comprehensive
    console.log('✅ User management data loaded');
  }
}

function addNewUser() {
  // Track user creation attempt
  if (window.activityTracker) {
    activityTracker.trackCustomActivity('user_creation_attempt', 'Admin initiated new user creation', {
      priority: 'medium',
      module: 'User Management'
    });
  }
  
  // Check permissions
  if (window.vbmsPermissions && !vbmsPermissions.hasPermission('users_create')) {
    alert('Access Denied: You do not have permission to create users.');
    return;
  }
  
  // In real app, this would open a modal with user creation form
  if (confirm('Create a new user account? This will open the user creation form.')) {
    showUserModal();
  }
}

function loadMainAdminStats() {
  // Simulate loading stats (in real app, these would come from API)
  const stats = {
    totalAdmins: 8,
    systemUptime: 99.9
  };

  // Update stat cards with animation
  setTimeout(() => {
    animateMainAdminStats('totalAdmins', stats.totalAdmins);
  }, 500);
}

function animateMainAdminStats(elementId, targetValue, prefix = '', isNumber = false) {
  const element = document.getElementById(elementId);
  if (!element) return;

  let currentValue = 0;
  const increment = targetValue / 50;
  const timer = setInterval(() => {
    currentValue += increment;
    if (currentValue >= targetValue) {
      currentValue = targetValue;
      clearInterval(timer);
    }
    
    let displayValue = Math.floor(currentValue);
    if (isNumber && displayValue >= 1000) {
      displayValue = displayValue.toLocaleString();
    }
    
    element.textContent = prefix + displayValue + (elementId === 'systemUptime' ? '%' : '');
  }, 20);
}

function addNewAdmin() {
  // Track admin creation attempt
  if (window.activityTracker) {
    activityTracker.trackCustomActivity('admin_creation_attempt', 'Main Admin initiated new admin creation', {
      priority: 'high',
      module: 'Admin Management'
    });
  }
  
  // Check permissions
  if (window.vbmsPermissions && !vbmsPermissions.hasPermission('admin_create')) {
    alert('Access Denied: You do not have permission to create admin accounts.');
    return;
  }
  
  // Show user modal pre-configured for admin creation
  showUserModal('admin');
}

function showUserModal(defaultRole = '') {
  // Initialize permissions grid
  initializePermissionsGrid();
  
  // Set default role if provided
  if (defaultRole) {
    document.getElementById('userRole').value = defaultRole;
    updatePermissionsForRole(defaultRole);
  }
  
  // Show the modal
  const modal = new bootstrap.Modal(document.getElementById('userModal'));
  modal.show();
}

function initializePermissionsGrid() {
  if (!window.vbmsPermissions) {
    console.log('⚠️ Permissions manager not available');
    return;
  }
  
  const permissionsGrid = document.getElementById('permissionsGrid');
  const categories = vbmsPermissions.getPermissionCategories();
  
  let gridHTML = '';
  
  for (const [categoryName, permissions] of Object.entries(categories)) {
    const categoryId = categoryName.toLowerCase().replace(/[^a-z0-9]/g, '');
    
    gridHTML += `
      <div class="permission-category">
        <div class="permission-category-header">
          <i class="bi bi-shield-check"></i>
          ${categoryName}
        </div>
        <div class="permission-category-body">
          <div class="select-all-category">
            <input type="checkbox" class="select-all-checkbox" id="selectAll_${categoryId}" 
                   onchange="toggleCategoryPermissions('${categoryId}')">
            <label for="selectAll_${categoryId}">Select All ${categoryName}</label>
          </div>
    `;
    
    for (const permission of permissions) {
      gridHTML += `
        <div class="permission-row">
          <div class="permission-info">
            <div class="permission-label">${permission.label}</div>
            <div class="permission-description">${permission.description}</div>
          </div>
          <div class="permission-toggle">
            <input type="checkbox" class="permission-checkbox" 
                   id="perm_${permission.id}" 
                   data-category="${categoryId}"
                   data-permission="${permission.id}"
                   onchange="updateCategorySelectAll('${categoryId}')">
          </div>
        </div>
      `;
    }
    
    gridHTML += `
        </div>
      </div>
    `;
  }
  
  permissionsGrid.innerHTML = gridHTML;
  
  // Add role change listener
  document.getElementById('userRole').addEventListener('change', function(e) {
    updatePermissionsForRole(e.target.value);
  });
}

function updatePermissionsForRole(role) {
  if (!window.vbmsPermissions || !role) return;
  
  const rolePermissions = vbmsPermissions.ROLE_PERMISSIONS[role] || [];
  
  // Clear all checkboxes first
  document.querySelectorAll('.permission-checkbox').forEach(checkbox => {
    checkbox.checked = false;
  });
  
  // Check permissions for the selected role
  rolePermissions.forEach(permission => {
    const checkbox = document.getElementById(`perm_${permission}`);
    if (checkbox) {
      checkbox.checked = true;
    }
  });
  
  // Update select-all checkboxes
  updateAllCategorySelectAll();
}

function toggleCategoryPermissions(categoryId) {
  const selectAllCheckbox = document.getElementById(`selectAll_${categoryId}`);
  const categoryCheckboxes = document.querySelectorAll(`[data-category="${categoryId}"]`);
  
  categoryCheckboxes.forEach(checkbox => {
    checkbox.checked = selectAllCheckbox.checked;
  });
}

function updateCategorySelectAll(categoryId) {
  const categoryCheckboxes = document.querySelectorAll(`[data-category="${categoryId}"]`);
  const selectAllCheckbox = document.getElementById(`selectAll_${categoryId}`);
  
  const checkedCount = Array.from(categoryCheckboxes).filter(cb => cb.checked).length;
  const totalCount = categoryCheckboxes.length;
  
  selectAllCheckbox.checked = checkedCount === totalCount;
  selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < totalCount;
}

function updateAllCategorySelectAll() {
  // Update all category select-all checkboxes
  const categories = ['customer management', 'reports & analytics', 'user management', 'admin management', 'orders & billing', 'system settings'];
  categories.forEach(category => {
    const categoryId = category.replace(/[^a-z0-9]/g, '');
    updateCategorySelectAll(categoryId);
  });
}

function saveUser() {
  // Get form data
  const formData = {
    name: document.getElementById('userName').value,
    email: document.getElementById('userEmail').value,
    role: document.getElementById('userRole').value,
    status: document.getElementById('userStatus').value,
    password: document.getElementById('userPassword').value,
    requirePasswordChange: document.getElementById('requirePasswordChange').checked,
    customPermissions: []
  };
  
  // Validate required fields
  if (!formData.name || !formData.email || !formData.role) {
    alert('Please fill in all required fields.');
    return;
  }
  
  // Validate password confirmation if password is provided
  const confirmPassword = document.getElementById('confirmPassword').value;
  if (formData.password && formData.password !== confirmPassword) {
    alert('Passwords do not match.');
    return;
  }
  
  // Get selected permissions
  document.querySelectorAll('.permission-checkbox:checked').forEach(checkbox => {
    formData.customPermissions.push(checkbox.dataset.permission);
  });
  
  // Simulate saving user (in real app, this would be an API call)
  console.log('💾 Saving user:', formData);
  
  if (window.activityTracker) {
    activityTracker.trackCustomActivity('user_created', `New user created: ${formData.name}`, {
      priority: 'high',
      module: 'User Management',
      user: formData.name,
      role: formData.role
    });
  }
  
  // Close modal and refresh data
  const modal = bootstrap.Modal.getInstance(document.getElementById('userModal'));
  modal.hide();
  
  // Simulate adding user to the table
  addUserToTable(formData);
  
  alert(`User "${formData.name}" has been created successfully!`);
}

function addUserToTable(userData) {
  const tableBody = document.getElementById('usersTableBody');
  if (!tableBody) return;
  
  const avatarInitials = userData.name.split(' ').map(n => n[0]).join('').toUpperCase();
  const roleDisplayName = userData.role === 'main_admin' ? 'Main Admin' : 
                         userData.role.charAt(0).toUpperCase() + userData.role.slice(1);
  
  const roleBadgeClass = userData.role === 'main_admin' ? 'badge-main-admin' : 
                        userData.role === 'admin' ? 'badge-admin' : 
                        userData.role === 'support' ? 'badge-support' : 'badge-admin';
  
  const permissionsBadgeClass = userData.customPermissions.length > 10 ? 'badge-full' : 
                               userData.customPermissions.length > 5 ? 'badge-limited' : 'badge-readonly';
  
  const permissionsLabel = userData.customPermissions.length > 10 ? 'Full Access' : 
                          userData.customPermissions.length > 5 ? 'Limited' : 'Read Only';
  
  const statusBadgeClass = userData.status === 'active' ? 'badge-active' : 'badge-inactive';
  
  const newRow = `
    <tr>
      <td>
        <div class="d-flex align-items-center">
          <div class="admin-avatar">${avatarInitials}</div>
          <strong>${userData.name}</strong>
        </div>
      </td>
      <td>${userData.email}</td>
      <td><span class="badge ${roleBadgeClass}">${roleDisplayName}</span></td>
      <td><span class="badge ${permissionsBadgeClass}">${permissionsLabel}</span></td>
      <td><span class="badge ${statusBadgeClass}">${userData.status.charAt(0).toUpperCase() + userData.status.slice(1)}</span></td>
      <td>Just now</td>
      <td>
        <a href="#" class="action-btn" onclick="editUser('${userData.email}')"><i class="bi bi-eye"></i> View</a>
        <a href="#" class="action-btn" onclick="editUser('${userData.email}')"><i class="bi bi-pencil"></i> Edit</a>
        <a href="#" class="action-btn btn-danger" onclick="deleteUser('${userData.email}')"><i class="bi bi-x-circle"></i> Delete</a>
      </td>
    </tr>
  `;
  
  tableBody.insertAdjacentHTML('beforeend', newRow);
}

function editUser(userEmail) {
  // Simulate loading user data for editing
  console.log('✏️ Editing user:', userEmail);
  
  if (window.vbmsPermissions && !vbmsPermissions.hasPermission('users_edit')) {
    alert('Access Denied: You do not have permission to edit users.');
    return;
  }
  
  alert(`Edit user functionality would load user data for: ${userEmail}`);
}

function deleteUser(userEmail) {
  if (window.vbmsPermissions && !vbmsPermissions.hasPermission('users_delete')) {
    alert('Access Denied: You do not have permission to delete users.');
    return;
  }
  
  if (confirm(`Are you sure you want to delete the user with email: ${userEmail}?`)) {
    console.log('🗑️ Deleting user:', userEmail);
    alert('User deleted successfully!');
  }
}

// Verification function for role-based access control
function verifyRoleBasedAccess() {
  console.log('=== ROLE-BASED ACCESS VERIFICATION ===');
  
  if (!vbmsAuth.isAuthenticated()) {
    console.log('❌ User not authenticated');
    return false;
  }
  
  const role = vbmsAuth.getCurrentRole();
  const isMainAdmin = vbmsAuth.isMainAdmin();
  const isRegularAdmin = vbmsAuth.isAdmin() && !vbmsAuth.isMainAdmin();
  
  console.log(`✓ Current role: ${role}`);
  console.log(`✓ Is main admin: ${isMainAdmin}`);
  console.log(`✓ Is regular admin: ${isRegularAdmin}`);
  
  // Check if main admin sections are properly shown/hidden
  const adminManagementSection = document.getElementById('adminManagementSection');
  const mainAdminStats = document.getElementById('mainAdminStats');
  
  if (isMainAdmin) {
    const managementVisible = adminManagementSection && adminManagementSection.style.display !== 'none';
    const statsVisible = mainAdminStats && mainAdminStats.style.display !== 'none';
    
    console.log(`✓ Admin management section visible: ${managementVisible}`);
    console.log(`✓ Main admin stats visible: ${statsVisible}`);
    
    if (!managementVisible || !statsVisible) {
      console.log('⚠️ Main admin sections should be visible but are hidden');
    }
  } else if (isRegularAdmin) {
    const managementHidden = !adminManagementSection || adminManagementSection.style.display === 'none';
    const statsHidden = !mainAdminStats || mainAdminStats.style.display === 'none';
    
    console.log(`✓ Admin management section hidden: ${managementHidden}`);
    console.log(`✓ Main admin stats hidden: ${statsHidden}`);
    
    if (!managementHidden || !statsHidden) {
      console.log('⚠️ Main admin sections should be hidden but are visible');
    }
  }
  
  console.log('=== VERIFICATION COMPLETE ===');
  return true;
}

// Standard Admin Dashboard Initialization
function initializeAdminUI() {
  console.log('🎯 Initializing standard admin dashboard...');
  
  // Initialize standard admin features
  const role = vbmsAuth.getCurrentRole();
  
  if (role === 'admin' || role === 'support') {
    // Show regular admin sections
    console.log('✅ Standard admin dashboard initialized');
  } else if (role === 'main_admin') {
    // Main admins should use the dedicated admin-main-dashboard.html
    console.log('⚠️ Main Admin detected - redirecting to dedicated dashboard');
    window.location.href = 'admin-main-dashboard.html';
    return;
  }
}

// Start the authentication check with retry logic after a small delay to ensure all scripts are loaded
setTimeout(() => {
  checkAuthWithRetry();
  
  // Run verification after initialization
  setTimeout(() => {
    verifyRoleBasedAccess();
  }, 1000);
}, 50);
</script>
<!-- Removed the THREE.js and Vanta.NET scripts to eliminate deprecation warnings -->
<script>
// Sidebar collapse toggle
document.getElementById('toggleSidebar').onclick = () => {
  const sidebar = document.getElementById('sidebar');
  const btnIcon = document.querySelector('#toggleSidebar i');

  if (window.innerWidth <= 768) {
    sidebar.classList.toggle('open');
    // For mobile, always show X when open
    if (sidebar.classList.contains('open')) {
      btnIcon.classList.remove('bi-list');
      btnIcon.classList.add('bi-x');
    } else {
      btnIcon.classList.remove('bi-x');
      btnIcon.classList.add('bi-list');
    }
  } else {
    sidebar.classList.toggle('collapsed');
    // For desktop, toggle between list and x
    if (sidebar.classList.contains('collapsed')) {
      btnIcon.classList.remove('bi-list');
      btnIcon.classList.add('bi-x');
    } else {
      btnIcon.classList.remove('bi-x');
      btnIcon.classList.add('bi-list');
    }
  }
};

// Close sidebar when clicking outside on mobile
document.addEventListener('click', function(e) {
  const sidebar = document.getElementById('sidebar');
  const toggleBtn = document.getElementById('toggleSidebar');

  if (window.innerWidth <= 768 && sidebar.classList.contains('open')) {
    if (!sidebar.contains(e.target) && !toggleBtn.contains(e.target)) {
      sidebar.classList.remove('open');
      const btnIcon = document.querySelector('#toggleSidebar i');
      btnIcon.classList.remove('bi-x');
      btnIcon.classList.add('bi-list');
    }
  }
});

// User dropdown
const userBtn = document.getElementById('userDropdownBtn');
const userMenu = document.getElementById('userDropdownMenu');
userBtn.onclick = function(e){
  e.stopPropagation();
  userMenu.classList.toggle('show');
  notifDropdown.classList.remove('show');
};
userMenu.addEventListener('click', function(e){ e.stopPropagation(); });

// Notification dropdown
const notifBtn = document.getElementById('notifBtn');
const notifDropdown = document.getElementById('notifDropdown');
notifBtn.onclick = function(e){
  e.stopPropagation();
  notifDropdown.classList.toggle('show');
  userMenu.classList.remove('show');
};
notifDropdown.addEventListener('click', function(e){ e.stopPropagation(); });

// Hide dropdowns when clicking outside
document.body.addEventListener('click', function(){
  userMenu.classList.remove('show');
  notifDropdown.classList.remove('show');
});

// Theme management debugging and setup
document.addEventListener('DOMContentLoaded', function() {
  console.log('Dashboard loaded, setting up theme...');
  
  // Force initialize theme manager
  setTimeout(() => {
    if (window.vbmsThemeManager) {
      console.log('Theme manager found, initializing...');
      window.vbmsThemeManager.initializeThemeToggle();
    } else {
      console.log('Theme manager not found, creating fallback...');
      // Fallback theme functionality
      const themeBtn = document.getElementById('darkModeBtn');
      if (themeBtn) {
        console.log('Theme button found, adding listener...');
        themeBtn.addEventListener('click', function(e) {
          e.preventDefault();
          console.log('Theme button clicked!');
          const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
          const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
          console.log('Switching from', currentTheme, 'to', newTheme);
          
          document.documentElement.setAttribute('data-theme', newTheme);
          localStorage.setItem('vbms-theme', newTheme);
          
          // Update button icon
          const icon = themeBtn.querySelector('i');
          if (icon) {
            icon.className = newTheme === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-fill';
          }
        });
      } else {
        console.log('Theme button not found!');
      }
    }
  }, 500);
});

// Progress Bars Animate
window.addEventListener('DOMContentLoaded', function(){
  setTimeout(function(){
    document.getElementById('tasksBar').style.width = '70%';
    document.getElementById('goalBar').style.width = '50%';
  }, 300);
});

// Logs out the user using the auth system
function logout(){
  vbmsAuth.logout();
}
</script>

<script>
  function animateCount(id) {
    const el = document.getElementById(id);
    if (!el) return;
    const target = +el.getAttribute('data-target');
    const duration = 2000;
    const start = performance.now();
    function update(time) {
      const elapsed = time - start;
      const progress = Math.min(elapsed / duration, 1);
      const value = Math.floor(progress * target);
      el.textContent = value.toLocaleString();
      if (progress < 1) requestAnimationFrame(update);
    }
    requestAnimationFrame(update);
  }

  // Single API call on load - no repeated calls
  let isLoading = false;
  document.addEventListener('DOMContentLoaded', async () => {
    if (isLoading) return;
    isLoading = true;

    // Fake count-up for design
    animateCount('ordersToday');
    animateCount('revenueToday');
    animateCount('revenueMonth');

    try {
      const response = await fetch('https://vbms-backend.onrender.com/api/dashboard', {
        method: 'GET'
      });

      const data = await response.json();

      if (!response.ok) {
        console.log("Dashboard API error: " + (data.message || "Unknown error"));
        return;
      }

      console.log("Dashboard API response:", data.message);

    } catch (err) {
      console.error('Dashboard fetch error:', err);
    } finally {
      isLoading = false;
    }
  });
</script>

<script>
console.log("Dashboard loaded");

  // Check authentication
  if (!vbmsAuth.requireRole('admin', 'login.html')) {
    // This will redirect if not authenticated or not admin
    throw new Error('Access denied');
  }

  // Enhanced Notification System (handled by notifications-manager.js)
  function toggleNotifications() {
    const notifDropdown = document.getElementById('notifDropdown');
    notifDropdown.classList.toggle('show');
    
    // Load fresh notifications when dropdown is opened
    if (notifDropdown.classList.contains('show') && window.vbmsNotifications) {
      vbmsNotifications.loadNotifications();
    }
  }

  // Create realistic sample activities for demonstration
  function createSampleActivities() {
    if (!window.activityTracker) return;
    
    // Simulate realistic business activities over time
    setTimeout(() => {
      activityTracker.trackCustomerSignup('John Smith', 'john.smith@email.com', 'Premium');
    }, 2000);

    setTimeout(() => {
      activityTracker.trackPaymentReceived(149.00, 'John Smith', 'stripe', 'ORD-2024-001');
    }, 5000);

    setTimeout(() => {
      activityTracker.trackOrderCreated('ORD-2024-002', 'Sarah Johnson', 299.99, ['Video Monitoring Setup', 'AI Assistant License']);
    }, 8000);

    setTimeout(() => {
      activityTracker.trackStaffAssigned('Mike Davis', 'Customer Onboarding', 'Sarah Johnson');
    }, 12000);

    setTimeout(() => {
      activityTracker.trackInventoryLow('HD Security Camera', 5, 10);
    }, 15000);

    setTimeout(() => {
      activityTracker.trackAIChat('Lisa Chen', 'Inventory Management', '3 minutes');
    }, 18000);

    setTimeout(() => {
      activityTracker.trackTrainingCompleted('Alex Rodriguez', 'VBMS Platform Fundamentals', 95, '2.5 hours');
    }, 22000);

    setTimeout(() => {
      activityTracker.trackAffiliateSignup('Digital Marketing Pro', 'affiliate@dmtpro.com', 'DMP2024');
    }, 26000);

    setTimeout(() => {
      activityTracker.trackSupportTicket('TKT-001', 'Emma Wilson', 'Unable to access video feeds', 'high');
    }, 30000);

    setTimeout(() => {
      activityTracker.trackVideoAlert('Motion Detection', 'Main Warehouse - Camera 3', 'medium');
    }, 35000);
  }

  // Initialize sample activities after notifications system loads
  setTimeout(createSampleActivities, 3000);

  // New header functions
  function toggleUserMenu() {
    const userDropdown = document.getElementById('userDropdown');
    userDropdown.classList.toggle('show');
  }

  function markAllRead() {
    if (window.vbmsNotifications) {
      // Mark all notifications as read
      const notifications = JSON.parse(localStorage.getItem('vbmsActivities')) || [];
      notifications.forEach(n => n.read = true);
      localStorage.setItem('vbmsActivities', JSON.stringify(notifications));
      vbmsNotifications.updateNotificationUI();
    }
  }

  // Update date and time
  function updateDateTime() {
    const now = new Date();
    const dateOptions = { 
      weekday: 'long', 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    };
    const timeOptions = { 
      hour: '2-digit', 
      minute: '2-digit',
      second: '2-digit'
    };
    
    const currentDate = document.getElementById('currentDate');
    const currentTime = document.getElementById('currentTime');
    
    if (currentDate) {
      currentDate.textContent = now.toLocaleDateString('en-US', dateOptions);
    }
    if (currentTime) {
      currentTime.textContent = now.toLocaleTimeString('en-US', timeOptions);
    }
  }

  // Initialize datetime and update every second
  updateDateTime();
  setInterval(updateDateTime, 1000);

  // Close dropdowns when clicking outside
  document.addEventListener('click', function(e) {
    const userDropdown = document.getElementById('userDropdown');
    const notifDropdown = document.getElementById('notifDropdown');
    
    if (!e.target.closest('.user-menu')) {
      userDropdown.classList.remove('show');
    }
    if (!e.target.closest('.notifications-container')) {
      notifDropdown.classList.remove('show');
    }
  });
</script>

</body>
</html>