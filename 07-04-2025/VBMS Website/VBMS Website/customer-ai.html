<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Chat Agent - VBMS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="customer-theme.css" rel="stylesheet">
  <script src="config.js"></script>
  <script src="navigation-enforcement.js"></script>
  <script src="auth.js"></script>
  <script src="load-sidebar.js"></script>
  <script src="theme-manager.js"></script>
  <style>
    :root {
        --accent: #f0b90b;
        --accent-light: #ffd700;
        --accent-glow: rgba(240, 185, 11, 0.4);
        --primary-dark: #d4a109;
        --secondary: #2c3e50;
        --success: #22c55e;
        --danger: #ef4444;
        --warning: #f59e0b;
        --info: #3b82f6;
        --purple: #a855f7;
        --cyan: #06b6d4;
        --light: #f8f9fa;
        --dark: #212529;
        --glass: rgba(255,255,255,0.95);
        --glass-glow: rgba(240, 185, 11, 0.15);
        --border: #e9ecef;
        --text: #212529;
        --text-muted: #6c757d;
        --card-bg: #ffffff;
        --card-shadow: 0 8px 32px rgba(240, 185, 11, 0.1);
        --bg: linear-gradient(135deg, #f8f9fa 0%, #f0f8ff 50%, #f8f4ff 100%);
        --sidebar-bg: rgba(255,255,255,0.98);
        --sidebar-link: #333;
        --sidebar-link-active: #000;
        --input-bg: rgba(255, 255, 255, 0.9);
        --text-main: #212529;
        --table-header: rgba(248, 249, 250, 0.95);
        --card-shadow-heavy: 0 12px 40px rgba(240, 185, 11, 0.15);
    }

    /* Dark theme - Modern Black/Gray with Energy */
    [data-theme="dark"] {
        --bg: linear-gradient(135deg, #000000 0%, #0a0a0a 25%, #1a1a1a 50%, #0f0f0f 100%);
        --light: #ffffff;
        --dark: #000000;
        --text: #ffffff;
        --text-muted: #a1a1aa;
        --card-bg: rgba(20, 20, 20, 0.95);
        --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.8), 0 0 20px rgba(240, 185, 11, 0.15);
        --card-shadow-heavy: 0 12px 40px rgba(0, 0, 0, 0.6), 0 0 30px rgba(240, 185, 11, 0.2);
        --border: rgba(64, 64, 64, 0.4);
        --glass: rgba(18, 18, 18, 0.95);
        --glass-glow: rgba(240, 185, 11, 0.2);
        --sidebar-bg: rgba(12, 12, 12, 0.98);
        --sidebar-link: #d4d4d8;
        --sidebar-link-active: #ffffff;
        --accent: #f0b90b;
        --accent-light: #ffd700;
        --success: #22c55e;
        --danger: #ef4444;
        --warning: #f59e0b;
        --info: #3b82f6;
        --purple: #a855f7;
        --cyan: #06b6d4;
        --input-bg: rgba(30, 30, 30, 0.9);
        --text-main: #ffffff;
        --table-header: rgba(30, 30, 30, 0.95);
    }

    body {
        font-family: 'Inter', sans-serif;
        background: var(--bg);
        background-attachment: fixed;
        color: var(--text);
        margin: 0;
        padding: 0;
        transition: all 0.3s ease;
        min-height: 100vh;
        position: relative;
        overflow-x: hidden;
    }

    /* Animated Background Particles */
    body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: 
            radial-gradient(circle at 20% 80%, rgba(240, 185, 11, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(240, 185, 11, 0.08) 0%, transparent 50%),
            radial-gradient(circle at 40% 40%, rgba(240, 185, 11, 0.05) 0%, transparent 50%);
        animation: float 20s ease-in-out infinite;
        pointer-events: none;
        z-index: -1;
    }

    [data-theme="dark"] body::before {
        background: 
            radial-gradient(circle at 20% 80%, rgba(240, 185, 11, 0.15) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(240, 185, 11, 0.12) 0%, transparent 50%),
            radial-gradient(circle at 40% 40%, rgba(240, 185, 11, 0.08) 0%, transparent 50%);
    }

    @keyframes float {
        0%, 100% { transform: translateY(0px) rotate(0deg); }
        33% { transform: translateY(-30px) rotate(1deg); }
        66% { transform: translateY(-10px) rotate(-1deg); }
    }

    /* Main Content */
    .main-content {
        margin-left: 240px;
        padding: 36px 24px 24px 24px;
        min-height: 100vh;
        background: none;
        transition: background .3s;
        display: flex;
        flex-direction: column;
    }

    /* Enhanced Header */
    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding: 25px 35px;
        background: var(--glass);
        backdrop-filter: blur(15px);
        border: 1px solid var(--border);
        border-radius: 20px;
        box-shadow: var(--card-shadow);
        transition: all 0.3s ease;
    }

    .header:hover {
        transform: translateY(-2px);
        box-shadow: 
            0 15px 40px rgba(240, 185, 11, 0.2),
            0 0 0 1px rgba(240, 185, 11, 0.1);
    }

    .header h1 {
        color: var(--accent);
        font-weight: 800;
        font-size: 2rem;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 12px;
        text-shadow: 0 2px 10px rgba(240, 185, 11, 0.3);
    }

    .header-controls {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .btn-theme {
        background: var(--glass);
        backdrop-filter: blur(10px);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px 16px;
        color: var(--accent);
        font-size: 1.2rem;
        transition: all 0.3s ease;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(240, 185, 11, 0.1);
    }

    .btn-theme:hover {
        background: var(--accent);
        color: #000;
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 8px 25px rgba(240, 185, 11, 0.3);
    }

    .badge {
        background: linear-gradient(135deg, var(--warning), var(--accent));
        color: #000;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 700;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
    }

    /* Enhanced Chat Container */
    .chat-container {
        flex: 1;
        background: var(--glass);
        backdrop-filter: blur(15px);
        border: 1px solid var(--border);
        border-radius: 20px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: var(--card-shadow);
        transition: all 0.3s ease;
        min-height: 600px;
    }

    .chat-container:hover {
        box-shadow: 
            0 15px 40px rgba(240, 185, 11, 0.2),
            0 0 0 1px rgba(240, 185, 11, 0.1);
    }

    .chat-header {
        background: linear-gradient(135deg, var(--accent), var(--accent-light));
        color: #000;
        padding: 20px 25px;
        display: flex;
        align-items: center;
        gap: 15px;
        position: relative;
    }

    .chat-header::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, transparent, rgba(0, 0, 0, 0.1), transparent);
    }

    .chat-header h5 {
        font-weight: 800;
        font-size: 1.2rem;
        margin-bottom: 2px;
    }

    .chat-header small {
        opacity: 0.8;
        font-weight: 500;
    }

    .online-badge {
        background: var(--success);
        color: #fff;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
        animation: pulse-glow 2s infinite;
    }

    @keyframes pulse-glow {
        0%, 100% { box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3); }
        50% { box-shadow: 0 4px 20px rgba(34, 197, 94, 0.5); }
    }

    .chat-messages {
        flex: 1;
        padding: 25px;
        overflow-y: auto;
        max-height: calc(100vh - 400px);
        scrollbar-width: thin;
        scrollbar-color: var(--accent) transparent;
    }

    .chat-messages::-webkit-scrollbar {
        width: 8px;
    }

    .chat-messages::-webkit-scrollbar-track {
        background: transparent;
    }

    .chat-messages::-webkit-scrollbar-thumb {
        background: var(--accent);
        border-radius: 4px;
    }

    .message {
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        animation: messageSlideIn 0.3s ease;
    }

    @keyframes messageSlideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message.user {
        justify-content: flex-end;
        flex-direction: row-reverse;
    }

    .message-content {
        max-width: 70%;
        padding: 16px 20px;
        border-radius: 20px;
        word-wrap: break-word;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .message-content::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s ease;
    }

    .message-content:hover::before {
        left: 100%;
    }

    .message.user .message-content {
        background: linear-gradient(135deg, var(--accent), var(--accent-light));
        color: #000;
        font-weight: 600;
        border-bottom-right-radius: 8px;
    }

    .message.ai .message-content {
        background: var(--glass);
        backdrop-filter: blur(10px);
        border: 1px solid var(--border);
        color: var(--text);
        border-bottom-left-radius: 8px;
    }

    .message-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 1.2rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }

    .message-avatar:hover {
        transform: scale(1.1);
    }

    .message.user .message-avatar {
        background: linear-gradient(135deg, var(--info), var(--cyan));
        color: #fff;
    }

    .message.ai .message-avatar {
        background: linear-gradient(135deg, var(--accent), var(--accent-light));
        color: #000;
    }

    /* Enhanced Input Container */
    .chat-input-container {
        padding: 25px;
        border-top: 1px solid var(--border);
        background: var(--glass);
        backdrop-filter: blur(10px);
    }

    .input-wrapper {
        display: flex;
        align-items: flex-end;
        gap: 15px;
        background: var(--glass);
        backdrop-filter: blur(10px);
        border: 1px solid var(--border);
        border-radius: 25px;
        padding: 8px;
        box-shadow: 0 4px 15px rgba(240, 185, 11, 0.1);
        transition: all 0.3s ease;
    }

    .input-wrapper:focus-within {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(240, 185, 11, 0.1);
        transform: translateY(-2px);
    }

    .chat-input {
        background: transparent;
        border: none;
        border-radius: 20px;
        padding: 12px 20px;
        color: var(--text);
        width: 100%;
        resize: none;
        font-size: 1rem;
        line-height: 1.4;
        max-height: 120px;
    }

    .chat-input:focus {
        outline: none;
    }

    .chat-input::placeholder {
        color: var(--text-muted);
    }

    .send-button {
        background: var(--accent);
        color: #000;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1.2rem;
        font-weight: 600;
        box-shadow: 0 4px 15px rgba(240, 185, 11, 0.3);
    }

    .send-button:hover {
        background: var(--accent-light);
        transform: scale(1.1) rotate(15deg);
        box-shadow: 0 6px 20px rgba(240, 185, 11, 0.4);
    }

    .send-button:active {
        transform: scale(0.95) rotate(15deg);
    }

    /* Enhanced Typing Indicator */
    .typing-indicator {
        display: none;
        align-items: center;
        gap: 15px;
        color: var(--text-muted);
        font-style: italic;
        margin: 20px 0;
        padding: 16px 20px;
        background: var(--glass);
        backdrop-filter: blur(10px);
        border: 1px solid var(--border);
        border-radius: 20px;
        border-bottom-left-radius: 8px;
        animation: messageSlideIn 0.3s ease;
    }

    .typing-dots {
        display: flex;
        gap: 4px;
    }

    .typing-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--accent);
        animation: typing 1.4s infinite;
        box-shadow: 0 2px 8px rgba(240, 185, 11, 0.3);
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
        0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
        30% { transform: translateY(-12px); opacity: 1; }
    }

    /* Enhanced Suggestions */
    .suggestions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 20px;
    }

    .suggestion-chip {
        background: var(--glass);
        backdrop-filter: blur(10px);
        color: var(--accent);
        border: 1px solid var(--accent);
        border-radius: 25px;
        padding: 10px 18px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(240, 185, 11, 0.1);
        position: relative;
        overflow: hidden;
    }

    .suggestion-chip::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(240, 185, 11, 0.2), transparent);
        transition: left 0.5s ease;
    }

    .suggestion-chip:hover::before {
        left: 100%;
    }

    .suggestion-chip:hover {
        background: var(--accent);
        color: #000;
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 6px 20px rgba(240, 185, 11, 0.3);
    }

    /* Enhanced Toast Container */
    .toast-container {
        position: fixed;
        top: 30px;
        right: 30px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .toast-vbms {
        background: var(--glass);
        backdrop-filter: blur(15px);
        border: 1px solid var(--accent);
        border-radius: 16px;
        padding: 16px 24px;
        color: var(--text);
        font-size: 1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 
            0 8px 25px rgba(240, 185, 11, 0.3),
            0 0 0 1px rgba(240, 185, 11, 0.1);
        animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        transition: all 0.3s ease;
        min-width: 280px;
        position: relative;
        overflow: hidden;
    }

    .toast-vbms::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--accent), var(--accent-light));
    }

    .toast-vbms i {
        color: var(--accent);
        font-size: 1.2rem;
    }

    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(100px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
        .main-content {
            margin-left: 0;
            padding: 20px 15px;
        }

        .vbms-sidebar {
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            position: fixed;
            z-index: 1000;
            width: 280px;
        }

        .vbms-sidebar.open {
            transform: translateX(0);
        }
    }

    @media (max-width: 768px) {
        .main-content {
            padding: 15px 10px;
        }

        .header {
            flex-direction: column;
            gap: 15px;
            text-align: center;
            padding: 20px;
        }

        .header h1 {
            font-size: 1.5rem;
        }

        .chat-messages {
            padding: 20px 15px;
        }

        .message-content {
            max-width: 85%;
            padding: 14px 16px;
        }

        .chat-input-container {
            padding: 20px 15px;
        }

        .suggestions {
            flex-direction: column;
            align-items: center;
        }

        .suggestion-chip {
            width: 100%;
            text-align: center;
            max-width: 280px;
        }

        .toast-container {
            top: 15px;
            right: 15px;
            left: 15px;
        }

        .toast-vbms {
            min-width: auto;
        }
    }

    @media (max-width: 480px) {
        .main-content {
            padding: 10px 8px;
        }

        .header {
            padding: 15px;
        }

        .header h1 {
            font-size: 1.3rem;
        }

        .chat-container {
            min-height: 500px;
        }

        .chat-messages {
            padding: 15px 10px;
        }

        .message-content {
            padding: 12px 14px;
        }

        .chat-input-container {
            padding: 15px 10px;
        }

        .send-button {
            width: 45px;
            height: 45px;
        }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div id="sidebar-container"></div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Enhanced Header -->
    <div class="header">
      <h1><i class="bi bi-robot"></i> AI Business Agent</h1>
      <div class="header-controls">
        <span class="badge">Beta</span>
        <button class="btn-theme" onclick="toggleTheme()" title="Toggle light/dark theme">
          <i id="themeIcon" class="bi bi-moon-fill"></i>
        </button>
      </div>
    </div>

    <div class="chat-container">
      <div class="chat-header">
        <div class="message-avatar">
          <i class="bi bi-robot"></i>
        </div>
        <div>
          <h5 class="mb-0">VBMS AI Agent</h5>
          <small>Here to help with your business questions</small>
        </div>
        <div class="ms-auto">
          <span class="online-badge">Online</span>
        </div>
      </div>

      <div class="chat-messages" id="chatMessages">
        <div class="message ai">
          <div class="message-avatar">
            <i class="bi bi-robot"></i>
          </div>
          <div class="message-content">
            <strong>Welcome!</strong> I'm your AI business agent. I can help you with:
            <ul class="mt-2 mb-0">
              <li>Business strategy and growth tips</li>
              <li>Inventory and order management</li>
              <li>Sales optimization</li>
              <li>Customer service best practices</li>
              <li>Understanding your VBMS dashboard</li>
            </ul>
            How can I assist you today?
          </div>
        </div>

        <div class="suggestions">
          <div class="suggestion-chip" onclick="sendQuickMessage('How do I increase customer retention?')">
            Customer Retention
          </div>
          <div class="suggestion-chip" onclick="sendQuickMessage('What are my top-selling products?')">
            Top Products
          </div>
          <div class="suggestion-chip" onclick="sendQuickMessage('Help me reduce costs')">
            Cost Reduction
          </div>
          <div class="suggestion-chip" onclick="sendQuickMessage('Marketing strategies for small business')">
            Marketing Tips
          </div>
        </div>

        <div class="typing-indicator" id="typingIndicator">
          <div class="message-avatar">
            <i class="bi bi-robot"></i>
          </div>
          <span>AI is thinking</span>
          <div class="typing-dots">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
          </div>
        </div>
      </div>

      <div class="chat-input-container">
        <div class="input-wrapper">
          <textarea 
            id="chatInput" 
            class="chat-input" 
            placeholder="Ask your AI agent anything about your business..."
            rows="1"
            onkeypress="handleKeyPress(event)"
          ></textarea>
          <button class="send-button" onclick="sendMessage()" title="Send Message">
            <i class="bi bi-send"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Enhanced Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
  </div>

  <script>
    // Check authentication
    document.addEventListener('DOMContentLoaded', function() {
      if (!vbmsAuth.isAuthenticated()) {
        window.location.href = 'customer-login.html';
        return;
      }

      // Role-based access control
      const userRole = vbmsAuth.getCurrentRole();
      if (userRole !== 'customer' && userRole !== 'client') {
        alert('Access Denied: Customer access required');
        window.location.href = vbmsAuth.getRoleRedirectUrl();
        return;
      }

      // Initialize theme
      const savedTheme = localStorage.getItem('vbms-theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      
      const icon = document.getElementById('themeIcon');
      if (icon) {
        icon.className = savedTheme === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-fill';
      }

      // Show welcome toast
      setTimeout(() => {
        showToast('AI Agent ready to assist you!', 'success', 'bi-robot');
      }, 500);
    });

    function handleKeyPress(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    function sendMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();

      if (!message) return;

      // Add user message to chat
      addMessage(message, 'user');
      input.value = '';

      // Show typing indicator
      showTypingIndicator();

      // Simulate AI response
      generateAIResponse(message);
      
      // Show toast for message sent
      showToast('Message sent to AI Agent', 'info', 'bi-send');
    }

    function sendQuickMessage(message) {
      document.getElementById('chatInput').value = message;
      showToast(`Selected: ${message}`, 'info', 'bi-chat-quote');
      sendMessage();
    }

    function addMessage(content, type) {
      const messagesContainer = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;

      const avatarDiv = document.createElement('div');
      avatarDiv.className = 'message-avatar';
      avatarDiv.innerHTML = type === 'user' ? '<i class="bi bi-person"></i>' : '<i class="bi bi-robot"></i>';

      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      contentDiv.innerHTML = content;

      if (type === 'user') {
        messageDiv.appendChild(contentDiv);
        messageDiv.appendChild(avatarDiv);
      } else {
        messageDiv.appendChild(avatarDiv);
        messageDiv.appendChild(contentDiv);
      }

      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function showTypingIndicator() {
      document.getElementById('typingIndicator').style.display = 'flex';
      const messagesContainer = document.getElementById('chatMessages');
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function hideTypingIndicator() {
      document.getElementById('typingIndicator').style.display = 'none';
    }

    async function generateAIResponse(message) {
      try {
        // Show typing indicator
        document.querySelector('.typing-indicator').style.display = 'block';

        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ 
            message: message,
            context: 'business assistant'
          })
        });

        if (!response.ok) {
          throw new Error('Failed to get AI response');
        }

        const data = await response.json();

        // Add AI response to chat
        addMessage(data.response, 'ai');
        showToast('AI response received', 'success', 'bi-check-circle');

        // Show fallback notice if API failed
        if (data.fallback) {
          setTimeout(() => {
            addMessage("ðŸ’¡ Tip: You can ask me about sales strategies, marketing, inventory management, customer service, team building, and financial planning!", 'ai');
          }, 1000);
        }

      } catch (error) {
        console.error('Error calling AI API:', error);

        // Fallback to keyword-based responses
        let fallbackResponse = "I'm experiencing some technical difficulties. Let me try to help with a basic response: ";

        // Simple keyword-based fallback responses
        if (message.toLowerCase().includes('sales') || message.toLowerCase().includes('revenue')) {
          fallbackResponse += "For sales growth, focus on customer retention, upselling, pricing optimization, and improving your sales funnel conversion rates.";
        } else if (message.toLowerCase().includes('marketing')) {
          fallbackResponse += "For marketing, consider digital marketing, email campaigns, local networking, referral programs, and SEO optimization.";
        } else if (message.toLowerCase().includes('inventory')) {
          fallbackResponse += "For inventory management, implement just-in-time ordering, ABC analysis, automated reorder points, and regular cycle counting.";
        } else if (message.toLowerCase().includes('customer')) {
          fallbackResponse += "For customer service, focus on quick responses, staff training, feedback systems, personalization, and follow-up procedures.";
        } else {
          fallbackResponse = "I'm having technical difficulties right now. Please try again in a moment, or feel free to ask about sales, marketing, inventory, customer service, or team management!";
        }

        addMessage(fallbackResponse, 'ai');
        showToast('Using fallback response', 'warning', 'bi-exclamation-triangle');
      } finally {
        // Hide typing indicator
        document.querySelector('.typing-indicator').style.display = 'none';
      }
    }

    function clearChat() {
      if (confirm('Are you sure you want to clear the chat history?')) {
        const messagesContainer = document.getElementById('chatMessages');
        // Keep only the welcome message
        const welcomeMessage = messagesContainer.firstElementChild;
        const suggestions = messagesContainer.querySelector('.suggestions');
        messagesContainer.innerHTML = '';
        messagesContainer.appendChild(welcomeMessage);
        messagesContainer.appendChild(suggestions);
        showToast('Chat history cleared', 'info', 'bi-trash');
      }
    }

    // ===== ENHANCED TOASTS =====
    function showToast(msg, type = 'info', icon = null) {
      const toast = document.createElement('div');
      toast.className = `toast-vbms ${type}`;
      
      const iconClass = icon || getToastIcon(type);
      toast.innerHTML = `<i class="bi ${iconClass}"></i> <span>${msg}</span>`;
      
      const container = document.getElementById('toastContainer');
      container.appendChild(toast);
      
      // Animate in
      setTimeout(() => toast.classList.add('show'), 100);
      
      // Remove after 4 seconds
      setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.3s ease-in forwards';
        setTimeout(() => {
          if (toast.parentNode) {
            container.removeChild(toast);
          }
        }, 300);
      }, 4000);
    }

    function getToastIcon(type) {
      const icons = {
        'success': 'bi-check-circle-fill',
        'error': 'bi-exclamation-triangle-fill', 
        'warning': 'bi-exclamation-circle-fill',
        'info': 'bi-info-circle-fill'
      };
      return icons[type] || 'bi-info-circle-fill';
    }

    // Theme functions
    function toggleTheme() {
      if (window.vbmsThemeManager) {
        window.vbmsThemeManager.toggleTheme();
      } else {
        // Fallback theme toggle
        const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('vbms-theme', newTheme);
        
        // Update button icon
        const icon = document.getElementById('themeIcon');
        if (icon) {
          icon.className = newTheme === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-fill';
        }
        
        showToast(`Switched to ${newTheme} theme`, 'info', 'bi-palette');
      }
    }

    // Add slideOutRight animation to CSS
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideOutRight {
        from {
          opacity: 1;
          transform: translateX(0);
        }
        to {
          opacity: 0;
          transform: translateX(100px);
        }
      }
    `;
    document.head.appendChild(style);

    // Auto-resize textarea
    document.getElementById('chatInput').addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
  </script>
</body>
</html>